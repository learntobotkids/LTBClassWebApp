<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnToBot Class - Project</title>
    <link rel="stylesheet" href="kids-theme.css">
    <link rel="stylesheet" href="mobile.css">
    <link rel="stylesheet" href="navbar.css">
    <script src="analytics.js"></script> <!-- Analytics Telemetry -->
    <style>
        /* ========================================
           PROJECT PAGE - MODERN REDESIGN
           Mobile-First | Glassmorphism | Brand Colors
           ======================================== */

        :root {
            --brand-primary: #009FF5;
            --brand-secondary: #071F4E;
            --brand-accent: #FFA100;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-primary: #FFFFFF;
            --text-secondary: #94A3B8;
            --success-green: #10B981;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #071F4E 50%, #0f2847 100%);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            padding-top: 70px;
            min-height: 100vh;
        }

        /* ========== PAGE LAYOUT ========== */
        .page-content {
            padding: 20px 16px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .project-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.3;
        }

        @media (min-width: 768px) {
            .project-title {
                font-size: 2.25rem;
            }
        }

        /* ========== PDF BUTTON ========== */
        .pdf-btn {
            background: linear-gradient(135deg, var(--brand-accent) 0%, #e68900 100%);
            color: var(--brand-secondary);
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(255, 161, 0, 0.3);
            transition: all 0.3s ease;
        }

        .pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 161, 0, 0.4);
        }

        /* ========== VIDEO PLAYER (Offline Mode) ========== */
        .video-player-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }

        .video-player-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Video Overlay Controls */
        .controls-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.4);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 20;
        }

        .video-player-container:hover .controls-overlay {
            opacity: 1;
        }

        .kid-controls-centered {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .big-btn {
            background: rgba(0, 159, 245, 0.9);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .big-btn:hover {
            transform: scale(1.1);
            background: var(--brand-primary);
            border-color: white;
        }

        .big-btn.play-btn {
            width: 80px;
            height: 80px;
            font-size: 1.8em;
            background: var(--brand-accent);
        }

        .big-btn.play-btn:hover {
            background: #e68900;
        }

        @media (min-width: 768px) {
            .big-btn {
                width: 70px;
                height: 70px;
                font-size: 1.5em;
            }

            .big-btn.play-btn {
                width: 100px;
                height: 100px;
                font-size: 2.2em;
            }
        }

        /* Timeline */
        .timeline-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.95), transparent);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 15px;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 20;
        }

        .video-player-container:hover .timeline-container {
            opacity: 1;
        }

        .time-display {
            color: white;
            font-weight: 600;
            font-family: 'Inter', monospace;
            font-size: 0.85em;
            min-width: 45px;
            text-align: center;
        }

        #videoTimeline {
            flex: 1;
            max-width: 60%;
            cursor: pointer;
            accent-color: var(--brand-primary);
            height: 6px;
        }

        /* Filmstrip (Hidden by default, show on hover) */
        .filmstrip-overlay {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 30;
        }

        .video-player-container:hover .filmstrip-overlay {
            opacity: 1;
            display: flex;
        }

        .filmstrip-track {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            width: 100%;
            padding-bottom: 5px;
        }

        .filmstrip-item {
            flex: 0 0 120px;
            height: 70px;
            background: var(--glass-bg);
            border-radius: 8px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .filmstrip-item:hover {
            transform: translateY(-3px);
            border-color: var(--brand-primary);
        }

        .filmstrip-item.active {
            border-color: var(--success-green);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }

        .filmstrip-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.8;
        }

        .filmstrip-number {
            position: absolute;
            top: 5px;
            left: 5px;
            background: var(--brand-primary);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 700;
        }

        .filmstrip-title {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 0.65em;
            padding: 3px 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ========== NAVIGATION BUTTONS (Offline Mode) ========== */
        .global-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .control-btn {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
            padding: 14px 24px;
            border-radius: 50px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .control-btn:hover:not(:disabled) {
            background: var(--brand-primary);
            border-color: var(--brand-primary);
            transform: translateY(-2px);
        }

        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        #videoCounter {
            color: var(--text-secondary);
            font-weight: 700;
            font-size: 1.1em;
        }

        /* ========== RATING MODAL ========== */
        .rating-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .rating-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .rating-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .star-rating {
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .star-rating span {
            cursor: pointer;
            color: #374151;
            transition: color 0.2s;
        }

        .star-rating span:hover,
        .star-rating span.active {
            color: var(--brand-accent);
        }

        .rating-comment {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1em;
            margin-bottom: 20px;
            resize: none;
        }

        .submit-rating-btn {
            background: var(--brand-primary);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .submit-rating-btn:hover {
            background: #0088d1;
            transform: translateY(-2px);
        }

        /* ========== PDF VIEWER ========== */
        .pdf-viewer {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            overflow: hidden;
            margin-top: 30px;
        }

        .pdf-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.3);
        }

        .pdf-viewer-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-pdf-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .close-pdf-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .pdf-embed {
            width: 100%;
            height: 80vh;
            border: none;
        }

        /* ========== FOOTER ========== */
        .footer {
            background: rgba(7, 31, 78, 0.95);
            color: var(--text-secondary);
            padding: 30px 20px;
            text-align: center;
            margin-top: 50px;
            font-size: 0.9em;
            border-top: 1px solid var(--glass-border);
        }

        .footer p {
            margin: 5px 0;
        }

        .footer a {
            color: var(--brand-primary);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* ========== LOADING STATE ========== */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            font-size: 1.2em;
        }

        /* ========== VIDEO PARTS SECTION (Shared for both modes) ========== */
        .parts-section {
            margin-top: 30px;
        }

        .parts-title {
            color: var(--text-primary);
            font-size: 1.25em;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .parts-grid {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--brand-primary) transparent;
        }

        .parts-grid::-webkit-scrollbar {
            height: 6px;
        }

        .parts-grid::-webkit-scrollbar-thumb {
            background: var(--brand-primary);
            border-radius: 6px;
        }

        .part-card {
            flex: 0 0 200px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .part-card:hover {
            border-color: var(--brand-primary);
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 159, 245, 0.2);
        }

        .part-card.active {
            border-color: var(--success-green);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .part-card-thumb {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #1F2937;
            overflow: hidden;
        }

        .part-card-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .part-card:hover .part-card-thumb img {
            transform: scale(1.05);
        }

        .part-card-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--brand-primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: 700;
        }

        .part-card-duration {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .part-card-title {
            padding: 14px;
            color: var(--text-primary);
            font-size: 0.95em;
            font-weight: 600;
            text-align: center;
        }

        /* ========== ONLINE MODE PLAYER ========== */
        .online-player-container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }

        .youtube-frame {
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 16px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            margin-bottom: 25px;
        }

        .youtube-frame iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Online Mode Navigation */
        .online-nav {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 30px;
        }

        @media (min-width: 600px) {
            .online-nav {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .online-nav-btn {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
            padding: 14px 28px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s ease;
            text-align: center;
        }

        .online-nav-btn:hover:not(:disabled) {
            background: var(--brand-primary);
            border-color: var(--brand-primary);
            transform: translateY(-2px);
        }

        .online-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .online-counter {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-secondary);
            text-align: center;
        }

        /* ========== MOBILE OPTIMIZATIONS ========== */
        @media (max-width: 600px) {
            .page-content {
                padding: 15px 12px;
            }

            .project-title {
                font-size: 1.4rem;
            }

            .video-player-container {
                border-radius: 12px;
            }

            .big-btn {
                width: 50px;
                height: 50px;
                font-size: 1em;
            }

            .big-btn.play-btn {
                width: 65px;
                height: 65px;
                font-size: 1.4em;
            }

            .control-btn,
            .online-nav-btn {
                padding: 12px 20px;
                font-size: 0.9em;
                width: 100%;
                justify-content: center;
            }

            .global-nav {
                flex-direction: column;
            }

            .part-card {
                flex: 0 0 160px;
            }

            .part-card-title {
                font-size: 0.85em;
                padding: 10px;
            }
        }
    </style>
</head>

<body>


    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">
                <img src="assets/logo.png" alt="LearnToBot" class="navbar-logo-img">
                <span class="brand-text">LEARNTOBOT</span>
            </a>

            <!-- Mobile menu button handled by mobile-nav.js -->

            <ul class="navbar-menu">
                <li><a href="/" class="navbar-link">Projects</a></li>
                <li><a href="/child-progress.html" class="navbar-link">Student Progress</a></li>
                <li><a href="/prizes.html" class="navbar-link">Prizes</a></li>
                <li><a href="/leaderboard.html" class="navbar-link">Leaders</a></li>
                <li><a href="/instructor-dashboard.html?tab=analytics" class="navbar-link" id="navAnalytics"
                        style="display: none;">Analytics</a></li>
                <li><a href="/instructor-dashboard.html" class="navbar-link">Instructors</a></li>
            </ul>

            <div class="navbar-auth">
                <div id="userProfilePill" class="user-profile-pill" style="display: none;">
                    <div class="user-points">
                        <span class="points-icon">üíé</span>
                        <span id="userPointsDisplay">0</span>
                    </div>
                    <div class="user-info">
                        <span id="userNameDisplay" class="user-name">Student</span>
                        <img id="userHeadshotDisplay" src="" alt="Profile" class="user-headshot-nav"
                            onerror="this.style.display='none'">
                    </div>
                </div>
                <button id="authBtn" class="navbar-btn" onclick="window.location.href='/'">Login</button>
            </div>
        </div>
    </nav>

    <div class="page-content">
        <div class="header">
            <h1 class="project-title" id="projectTitle">Loading...</h1>
            <button class="pdf-btn" id="pdfBtn" onclick="togglePDF()" style="display: none;">üìÑ View
                Instructions</button>
        </div>

        <div id="content">
            <!-- Dynamic Content will be loaded here -->
            <div class="loading">Loading project...</div>
        </div>

        <script>
            // ... (keeping existing variables) ...
            let currentProject = null;
            let currentVideoIndex = 0;
            let inactivityTimeout;

            // ========================================================================
            // DEPLOYMENT MODE - Fetched from server's environment variable
            // ========================================================================
            let DEPLOYMENT_MODE = 'offline'; // Default

            async function fetchDeploymentMode() {
                try {
                    const response = await fetch('/api/config');
                    const config = await response.json();
                    DEPLOYMENT_MODE = config.deploymentMode || 'offline';
                    console.log(`[Project Page] Deployment mode: ${DEPLOYMENT_MODE} (from server)`);
                } catch (error) {
                    console.warn('[Project Page] Could not fetch config, defaulting to offline mode');
                    DEPLOYMENT_MODE = 'offline';
                }
            }

            // Get project ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');

            // Initialize the page
            (async function init() {
                await fetchDeploymentMode();
                fetchUserProfile(); // [NEW]
                if (!projectId) {
                    showError('No project ID specified');
                } else {
                    loadProject();
                }
            })();

            function logout() {
                localStorage.removeItem('currentStudent');
                localStorage.removeItem('allProjectAccess');
                window.location.href = '/';
            }

            // [NEW] Update User Profile
            async function fetchUserProfile() {
                const currentStudent = localStorage.getItem('currentStudent');
                if (!currentStudent) return;

                // DOM Elements for Navbar
                const pill = document.getElementById('userProfilePill');
                const nameEl = document.getElementById('userNameDisplay');
                const pointsEl = document.getElementById('userPointsDisplay');
                const headshotEl = document.getElementById('userHeadshotDisplay');

                // Show Pill immediately if logged in
                if (pill) pill.style.display = 'flex';
                if (nameEl) nameEl.textContent = currentStudent;

                // [NEW] Show My Projects link
                const myProjectsLink = document.getElementById('navMyProjects');
                if (myProjectsLink) myProjectsLink.style.display = 'block';

                try {
                    const response = await fetch('/api/leaderboard');
                    const data = await response.json();

                    if (data.success && data.leaderboard) {
                        const student = data.leaderboard.find(s => s.name === currentStudent);
                        if (student) {
                            if (pointsEl) pointsEl.textContent = (student.totalPoints || 0).toLocaleString();

                            if (headshotEl) {
                                let headshotUrl = student.headshot;
                                if (headshotUrl) {
                                    if (headshotUrl.includes('Child Names_Images/')) {
                                        headshotUrl = headshotUrl.replace('Child Names_Images/', 'headshots/');
                                    } else if (!headshotUrl.startsWith('headshots/') && !headshotUrl.startsWith('http')) {
                                        headshotUrl = 'headshots/' + headshotUrl;
                                    }
                                    headshotEl.src = headshotUrl;
                                    headshotEl.style.display = 'block';
                                } else {
                                    headshotEl.src = `https://ui-avatars.com/api/?background=3B82F6&color=fff&name=${encodeURIComponent(student.name)}`;
                                    headshotEl.style.display = 'block';
                                }
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error updating navbar:', e);
                }
            }

            async function loadProject() {
                try {
                    // ========================================================================
                    // ONLINE MODE: Fetch project info and parts from Google Sheets
                    // ========================================================================
                    if (DEPLOYMENT_MODE === 'online') {
                        console.log('Loading project from Google Sheets (Online Mode)...');

                        // Fetch project details
                        const projectsResp = await fetch('/api/all-projects');
                        const projectsData = await projectsResp.json();

                        if (!projectsData.success) {
                            showError('Failed to load projects: ' + (projectsData.error || 'Unknown error'));
                            return;
                        }

                        // Find the project by ID
                        const projectInfo = projectsData.projects.find(p => p.id === projectId.toUpperCase());

                        if (!projectInfo) {
                            showError('Project not found: ' + projectId);
                            return;
                        }

                        // Fetch parts/videos for this project
                        const partsResp = await fetch(`/api/project-parts/${projectId}`);
                        const partsData = await partsResp.json();

                        if (!partsData.success) {
                            showError('Failed to load project parts: ' + (partsData.error || 'Unknown error'));
                            return;
                        }

                        // Build currentProject object compatible with existing displayProject()
                        currentProject = {
                            id: projectInfo.id,
                            name: projectInfo.name || projectInfo.id,
                            description: projectInfo.description || '',
                            category: projectInfo.category || '',
                            // Convert parts to videos array (YouTube URLs)
                            videos: partsData.parts.map(part => part.youtubeUrl),
                            // Store full parts data for filmstrip
                            parts: partsData.parts,
                            // No PDF in online mode
                            pdf: null,
                            icon: null,
                            videoCount: partsData.count
                        };

                        console.log(`Loaded project ${currentProject.name} with ${currentProject.videos.length} videos`);
                        displayProject();
                        return;
                    }

                    // ========================================================================
                    // OFFLINE MODE: Fetch from local project folders (original behavior)
                    // ========================================================================
                    const response = await fetch('/api/projects');
                    const data = await response.json();

                    if (data.error) { showError(data.error); return; }

                    currentProject = data.projects.find(p => p.id === projectId);

                    if (!currentProject) { showError('Project not found: ' + projectId); return; }

                    displayProject();
                } catch (error) {
                    showError('Failed to load project: ' + error.message);
                }
            }

            function displayProject() {
                document.getElementById('projectTitle').textContent = currentProject.name;

                // ========================================================================
                // ONLINE MODE: Simple YouTube player with part cards below
                // ========================================================================
                if (DEPLOYMENT_MODE === 'online') {
                    displayProjectOnline();
                    return;
                }

                // ========================================================================
                // OFFLINE MODE: Original immersive player layout (unchanged)
                // ========================================================================
                if (currentProject.pdf) {
                    document.getElementById('pdfBtn').style.display = 'block';
                }

                // Create the Immersive Player Layout
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="container">
                        
                        <!-- Main Player Container -->
                        <div class="video-player-container" id="playerContainer" onmousemove="resetInactivityTimer()" onmouseleave="hideControls()">
                            <video id="videoPlayer" onclick="togglePlay()" ontimeupdate="updateTimeline()" onloadedmetadata="initTimeline()" onended="onVideoEnded()">
                                Your browser does not support the video tag.
                            </video>
                            
                            <!-- Centered Overlay Controls -->
                            <div class="controls-overlay" onclick="togglePlay()">
                                <div class="kid-controls-centered" onclick="event.stopPropagation()">
                                    <button class="big-btn" onclick="seek(-10)" title="Rewind 10s">
                                        ‚è™ 10
                                    </button>
                                    
                                    <button class="big-btn play-btn" id="overlayPlayBtn" onclick="togglePlay()" title="Play/Pause">
                                        ‚ñ∂Ô∏è
                                    </button>
                                    
                                    <button class="big-btn" onclick="seek(10)" title="Forward 10s">
                                        10 ‚è©
                                    </button>
                                </div>
                            </div>

                            <!-- Timeline Bar -->
                            <div class="timeline-container" onclick="event.stopPropagation()">
                                <span id="currentTime" class="time-display">0:00</span>
                                <input type="range" id="videoTimeline" min="0" value="0" step="0.1" oninput="seekTo(this.value)">
                                <span id="duration" class="time-display">0:00</span>
                                
                                <select onchange="setPlaybackSpeed(this.value)" style="background:transparent; color:white; border:1px solid rgba(255,255,255,0.3); border-radius:5px; padding:5px; margin-left:10px; cursor:pointer;">
                                    <option value="1" style="color:black;">1x</option>
                                    <option value="1.5" style="color:black;">1.5x</option>
                                    <option value="2" style="color:black;">2x</option>
                                </select>
                                
                                <button onclick="toggleFullscreen()" style="background:transparent; border:none; color:white; cursor:pointer; margin-left:10px; flex-shrink: 0; min-width: 30px; display: flex; align-items: center; justify-content: center;" title="Fullscreen">
                                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
                                </button>
                            </div>

                            <!-- Bottom Filmstrip Overlay -->
                            <div class="filmstrip-overlay">
                                <div class="filmstrip-track" id="filmstripTrack">
                                    <!-- Filmstrip items will be injected here -->
                                </div>
                            </div>

                            <!-- Rating Modal (Overlay) -->
                            <div class="rating-modal" id="ratingModal" style="display: none;">
                                <div class="rating-content">
                                    <div class="rating-title">How did it go?</div>
                                    <div class="star-rating" id="starRating">
                                        <span onclick="setRating(1)">‚òÖ</span>
                                        <span onclick="setRating(2)">‚òÖ</span>
                                        <span onclick="setRating(3)">‚òÖ</span>
                                        <span onclick="setRating(4)">‚òÖ</span>
                                        <span onclick="setRating(5)">‚òÖ</span>
                                    </div>
                                    <textarea class="rating-comment" id="ratingComment" rows="3" placeholder="Any comments? (Optional)"></textarea>
                                    <button class="submit-rating-btn" onclick="submitRating()">Submit & Continue</button>
                                </div>
                            </div>
                        </div>

                        <!-- Global Navigation (Outside player) -->
                        <div class="global-nav">
                            <button class="control-btn" id="prevBtn" onclick="previousVideo()">‚èÆ Previous Video</button>
                            <div style="color: #9CA3AF; font-weight: bold; align-self: center;" id="videoCounter">1 / ${currentProject.videos.length}</div>
                            <button class="control-btn" id="nextBtn" onclick="nextVideo()">Next Video ‚è≠</button>
                        </div>
                        
                        <!-- PDF Viewer Container (Initially Hidden) -->
                        ${currentProject.pdf ? `
                        <div class="pdf-viewer" id="pdfViewer" style="display: none; width: 100%; max-width: 1200px; margin-top: 30px;">
                            <div class="pdf-viewer-header">
                                <div class="pdf-viewer-title">üìÑ Project Instructions</div>
                                <button class="close-pdf-btn" onclick="togglePDF()">‚úï Close</button>
                            </div>
                            <iframe class="pdf-embed" src="/projects/${encodeURIComponent(currentProject.id)}/${encodeURIComponent(currentProject.pdf)}"></iframe>
                        </div>` : ''}

                    </div>
                `;

                renderFilmstrip();
                playVideo(0);

                // Add Event Listeners for Play/Pause Button Toggle
                const videoElement = document.getElementById('videoPlayer');
                videoElement.addEventListener('play', updatePlayButton);
                videoElement.addEventListener('pause', updatePlayButton);
                updatePlayButton(); // Initial state
            }

            // ========================================================================
            // ONLINE MODE DISPLAY: Clean YouTube player + Part Cards
            // ========================================================================
            function displayProjectOnline() {
                // SECURITY CHECK: If online and not logged in, block content
                const student = localStorage.getItem('currentStudent');
                const instructor = localStorage.getItem('instructorLoggedIn');
                if (!student && !instructor) {
                    const content = document.getElementById('content');
                    content.innerHTML = `
                        <div style="text-align: center; padding: 50px 20px; color: white;">
                            <div style="font-size: 4em; margin-bottom: 20px;">üîí</div>
                            <h2 style="margin-bottom: 15px;">Login Required</h2>
                            <p style="color: #9CA3AF; margin-bottom: 30px;">
                                This project video is private using paid software. <br>
                                Please login with your student account to access the materials.
                            </p>
                            <a href="/" class="navbar-btn" style="padding: 12px 30px; font-size: 1.1em;">Go to Login</a>
                        </div>
                    `;
                    return;
                }

                const content = document.getElementById('content');
                const parts = currentProject.parts || [];

                // Build part cards HTML
                const partCardsHTML = parts.map((part, index) => {
                    const coverImage = part.coverImage || `https://img.youtube.com/vi/${extractVideoId(part.youtubeUrl)}/hqdefault.jpg`;
                    const title = part.partTitle || `Part ${index + 1}`;
                    const duration = part.duration || '';

                    return `
                        <div class="part-card ${index === 0 ? 'active' : ''}" onclick="playOnlinePart(${index})" data-index="${index}">
                            <div class="part-card-thumb">
                                <img src="${coverImage}" alt="${title}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22160%22 height=%2290%22><rect fill=%22%231F2937%22 width=%22160%22 height=%2290%22/><text fill=%22%23fff%22 x=%2280%22 y=%2250%22 text-anchor=%22middle%22 font-size=%2230%22>üé•</text></svg>'">
                                <span class="part-card-number">${index + 1}</span>
                                ${duration ? `<span class="part-card-duration">${duration}</span>` : ''}
                            </div>
                            <div class="part-card-title">${title}</div>
                        </div>
                    `;
                }).join('');

                content.innerHTML = `
                    <style>
                        .online-player-container {
                            width: 100%;
                            max-width: 1000px;
                            margin: 0 auto;
                            padding: 0 10px;
                            display: flex !important;
                            flex-direction: column !important;
                            height: auto !important;
                            min-height: 100% !important;
                            overflow: visible !important;
                        }
                        .youtube-frame {
                            position: relative;
                            width: 100%;
                            padding-bottom: 56.25%; /* 16:9 aspect ratio */
                            height: 0;
                            border-radius: 16px;
                            overflow: hidden;
                            background: #000;
                            margin-bottom: 20px;
                            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
                        }
                        .youtube-frame iframe {
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            border: none;
                        }
                        
                        /* Navigation Buttons */
                        .online-nav {
                            display: flex;
                            flex-direction: row;
                            flex-wrap: wrap;
                            justify-content: center;
                            align-items: center;
                            gap: 15px;
                            margin-bottom: 30px;
                            padding: 0 10px;
                        }
                        .online-nav-btn {
                            background: rgba(255, 255, 255, 0.08);
                            backdrop-filter: blur(10px);
                            color: white;
                            border: 1px solid rgba(255, 255, 255, 0.15);
                            padding: 14px 28px;
                            border-radius: 50px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 0.95em;
                            transition: all 0.3s ease;
                            min-width: 130px;
                            text-align: center;
                        }
                        .online-nav-btn:hover:not(:disabled) {
                            background: #009FF5;
                            border-color: #009FF5;
                            transform: translateY(-2px);
                        }
                        .online-nav-btn:disabled {
                            opacity: 0.4;
                            cursor: not-allowed;
                        }
                        .online-counter {
                            font-size: 1.4em;
                            font-weight: 700;
                            color: #94A3B8;
                            padding: 0 15px;
                        }
                        
                        /* Parts Section - Always Visible */
                        .parts-section {
                            margin-top: 20px;
                            display: block !important;
                        }
                        .parts-title {
                            color: #FFFFFF;
                            font-size: 1.2em;
                            margin-bottom: 20px;
                            font-weight: 700;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .parts-grid {
                            display: flex;
                            gap: 16px;
                            overflow-x: auto;
                            padding-bottom: 15px;
                            scrollbar-width: thin;
                            scrollbar-color: #009FF5 transparent;
                            -webkit-overflow-scrolling: touch;
                        }
                        .parts-grid::-webkit-scrollbar {
                            height: 6px;
                        }
                        .parts-grid::-webkit-scrollbar-thumb {
                            background: #009FF5;
                            border-radius: 6px;
                        }
                        
                        /* Part Cards */
                        .part-card {
                            flex: 0 0 180px;
                            min-width: 150px;
                            background: rgba(255, 255, 255, 0.08);
                            backdrop-filter: blur(10px);
                            border-radius: 14px;
                            overflow: hidden;
                            cursor: pointer;
                            border: 2px solid rgba(255, 255, 255, 0.1);
                            transition: all 0.3s ease;
                        }
                        .part-card:hover {
                            border-color: #009FF5;
                            transform: translateY(-4px);
                            box-shadow: 0 12px 30px rgba(0, 159, 245, 0.2);
                        }
                        .part-card.active {
                            border-color: #10B981;
                            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
                        }
                        .part-card-thumb {
                            position: relative;
                            width: 100%;
                            aspect-ratio: 16/9;
                            background: #1F2937;
                            overflow: hidden;
                        }
                        .part-card-thumb img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                            transition: transform 0.3s ease;
                        }
                        .part-card:hover .part-card-thumb img {
                            transform: scale(1.05);
                        }
                        .part-card-number {
                            position: absolute;
                            top: 8px;
                            left: 8px;
                            background: #009FF5;
                            color: white;
                            width: 26px;
                            height: 26px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 0.85em;
                            font-weight: 700;
                        }
                        .part-card-duration {
                            position: absolute;
                            bottom: 8px;
                            right: 8px;
                            background: rgba(0,0,0,0.85);
                            color: white;
                            padding: 3px 8px;
                            border-radius: 6px;
                            font-size: 0.75em;
                            font-weight: 600;
                        }
                        .part-card-title {
                            padding: 12px 10px;
                            color: #FFFFFF;
                            font-size: 0.9em;
                            font-weight: 600;
                            text-align: center;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        }

                        /* Mobile Optimizations */
                        @media (max-width: 600px) {
                            .online-nav {
                                display: flex !important;
                                flex-direction: column !important;
                                gap: 12px;
                                width: 100%;
                            }
                            .online-nav-btn {
                                display: flex !important;
                                visibility: visible !important;
                                width: 100%;
                                padding: 14px 20px;
                                justify-content: center;
                                align-items: center;
                            }
                            .online-counter {
                                order: -1;
                                font-size: 1.2em;
                                text-align: center;
                            }
                            .part-card {
                                flex: 0 0 150px;
                                min-width: 140px;
                            }
                            .parts-title {
                                font-size: 1em;
                            }
                        }
                    </style>
                    
                    <div class="online-player-container">
                        <!-- YouTube Player -->
                        <div class="youtube-frame" id="youtubeFrame">
                            <iframe id="youtubePlayer" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                        
                        <!-- Navigation -->
                        <div class="online-nav">
                            <button class="online-nav-btn" id="prevBtn" onclick="playOnlinePart(currentVideoIndex - 1)">‚èÆ Previous</button>
                            <span class="online-counter" id="videoCounter">1 / ${parts.length}</span>
                            <button class="online-nav-btn" id="nextBtn" onclick="playOnlinePart(currentVideoIndex + 1)">Next ‚è≠</button>
                        </div>
                        
                        <!-- Part Cards -->
                        <div class="parts-section">
                            <div class="parts-title">üìπ Video Parts</div>
                            <div class="parts-grid" id="partsGrid">
                                ${partCardsHTML}
                            </div>
                        </div>
                        
                        <!-- Footer inside content -->
                        <div class="inline-footer" style="text-align: center; padding: 30px 10px; margin-top: 40px; color: #9CA3AF; font-size: 0.85em;">
                            <p>Last Updated: ${new Date().toLocaleString()}</p>
                            <p>¬© 2026 LearnToBot. All rights reserved.</p>
                            <p><a href="#" style="color: #3B82F6;">Privacy Policy</a> | <a href="#" style="color: #3B82F6;">Terms of Service</a> | <a href="#" style="color: #3B82F6;">Help Center</a></p>
                        </div>
                    </div>
                `;

                // Play first video
                playOnlinePart(0);
            }

            // Helper to extract YouTube video ID
            function extractVideoId(url) {
                if (!url) return '';
                if (url.includes('youtu.be/')) {
                    return url.split('youtu.be/')[1].split('?')[0];
                } else if (url.includes('youtube.com/watch?v=')) {
                    return url.split('v=')[1].split('&')[0];
                }
                return url;
            }

            // Play a specific part (Online mode)
            function playOnlinePart(index) {
                const parts = currentProject.parts || [];
                if (index < 0 || index >= parts.length) return;

                currentVideoIndex = index;
                const part = parts[index];
                const videoId = extractVideoId(part.youtubeUrl);
                const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;

                // Update YouTube player
                const iframe = document.getElementById('youtubePlayer');
                if (iframe) {
                    iframe.src = embedUrl;
                }

                // Update counter
                const counter = document.getElementById('videoCounter');
                if (counter) {
                    counter.textContent = `${index + 1} / ${parts.length}`;
                }

                // Update navigation buttons
                document.getElementById('prevBtn').disabled = index === 0;
                document.getElementById('nextBtn').disabled = index === parts.length - 1;

                // Update active card styling
                document.querySelectorAll('.part-card').forEach((card, i) => {
                    card.classList.toggle('active', i === index);
                });
            }

            function renderFilmstrip() {
                const track = document.getElementById('filmstripTrack');

                // Check if we have parts data (Online mode) or just video URLs (Offline mode)
                const hasParts = currentProject.parts && currentProject.parts.length > 0;

                track.innerHTML = currentProject.videos.map((video, index) => {
                    // Get part info if available (Online mode)
                    const part = hasParts ? currentProject.parts[index] : null;

                    // Determine thumbnail
                    let thumbContent = '';
                    if (part && part.coverImage) {
                        // Use cover image from parts data (Online mode)
                        thumbContent = `<img src="${part.coverImage}" class="filmstrip-thumb" onerror="this.parentNode.innerHTML='<div style=\\'width:100%;height:100%;background:linear-gradient(45deg,#1F2937,#374151);display:flex;align-items:center;justify-content:center;font-size:2em\\'>üé•</div>'">`;
                    } else {
                        // Fallback to generic icon (Offline mode or no cover)
                        thumbContent = `<div style="width:100%; height:100%; background: linear-gradient(45deg, #1F2937, #374151); display:flex; align-items:center; justify-content:center; font-size:2em;">üé•</div>`;
                    }

                    // Determine title
                    let title = '';
                    if (part && part.partTitle) {
                        title = part.partTitle;
                    } else {
                        // Fallback to video filename for offline mode
                        title = video.split('/').pop();
                    }

                    return `
                    <div class="filmstrip-item ${index === currentVideoIndex ? 'active' : ''}" onclick="playVideo(${index})">
                        <div class="filmstrip-number">${index + 1}</div>
                        ${thumbContent}
                        <div class="filmstrip-title">${title}</div>
                    </div>
                    `;
                }).join('');
            }


            function playVideo(index) {
                if (index < 0 || index >= currentProject.videos.length) return;

                currentVideoIndex = index;
                const video = currentProject.videos[index];

                // Check if this is a YouTube URL
                const isYouTube = video.includes('youtu.be') || video.includes('youtube.com');

                if (isYouTube) {
                    // Convert YouTube URL to embed format
                    let videoId = '';
                    if (video.includes('youtu.be/')) {
                        videoId = video.split('youtu.be/')[1].split('?')[0];
                    } else if (video.includes('youtube.com/watch?v=')) {
                        videoId = video.split('v=')[1].split('&')[0];
                    }

                    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;

                    // Find or create video player area
                    let videoPlayer = document.getElementById('videoPlayer');
                    let youtubePlayer = document.getElementById('youtubePlayer');

                    if (youtubePlayer) {
                        // Just update the src
                        youtubePlayer.src = embedUrl;
                    } else if (videoPlayer) {
                        // Replace video element with YouTube iframe
                        videoPlayer.insertAdjacentHTML('afterend', `
                            <iframe 
                                id="youtubePlayer"
                                src="${embedUrl}"
                                style="width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0;"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen>
                            </iframe>
                        `);
                        videoPlayer.style.display = 'none';
                    } else {
                        // No player exists, create one in playerContainer
                        const container = document.getElementById('playerContainer');
                        const existingIframe = container.querySelector('iframe');
                        if (existingIframe) {
                            existingIframe.src = embedUrl;
                        } else {
                            container.insertAdjacentHTML('afterbegin', `
                                <iframe 
                                    id="youtubePlayer"
                                    src="${embedUrl}"
                                    style="width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0;"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                    allowfullscreen>
                                </iframe>
                            `);
                        }
                    }
                } else {
                    // Local video file - use HTML5 video player
                    // Encode each path segment separately
                    const projectIdSegments = currentProject.id.split('/').map(seg => encodeURIComponent(seg)).join('/');
                    const videoSegments = video.split('/').map(seg => encodeURIComponent(seg)).join('/');
                    const videoPath = `/projects/${projectIdSegments}/${videoSegments}`;

                    // Use the video player
                    const player = document.getElementById('videoPlayer');
                    if (player) {
                        player.src = videoPath;
                    }
                }

                // Update active state in filmstrip
                renderFilmstrip();

                // Update global nav button states
                document.getElementById('prevBtn').disabled = index === 0;
                document.getElementById('nextBtn').disabled = index === currentProject.videos.length - 1;

                // Update counter
                const counter = document.getElementById('videoCounter');
                if (counter) counter.textContent = `${index + 1} / ${currentProject.videos.length}`;

                // Update play button state (reset to pause icon on new video load)
                updatePlayButton();
            }

            function previousVideo() {
                playVideo(currentVideoIndex - 1);
            }

            function nextVideo() {
                playVideo(currentVideoIndex + 1);
            }

            // ... (keep PDF toggle) ...

            // ... (keep showError) ...

            // ... (keep DOMContentLoaded / shortcuts) ...

            function togglePlay() {
                const video = document.getElementById('videoPlayer');
                if (video.paused) {
                    video.play();
                } else {
                    video.pause();
                }
                updatePlayButton();
            }

            function updatePlayButton() {
                const video = document.getElementById('videoPlayer');
                const btn = document.getElementById('overlayPlayBtn');

                if (!video || !btn) return;

                if (video.paused) {
                    btn.textContent = '‚ñ∂Ô∏è';
                    btn.classList.remove('paused-state');
                } else {
                    btn.textContent = '‚è∏Ô∏è';
                    btn.classList.add('paused-state');
                }
            }

            function seek(seconds) {
                const video = document.getElementById('videoPlayer');
                video.currentTime += seconds;
            }

            function togglePDF() {
                const pdfViewer = document.getElementById('pdfViewer');
                if (!pdfViewer) return;

                if (pdfViewer.style.display === 'none') {
                    pdfViewer.style.display = 'block';
                    // Scroll to the viewer
                    setTimeout(() => {
                        pdfViewer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                } else {
                    pdfViewer.style.display = 'none';
                }
            }

            // Update connection count
            async function updateConnectionCount() {
                try {
                    const response = await fetch('/api/connections');
                    const data = await response.json();
                    const btn = document.getElementById('connectionBtn');
                    if (btn && data.stats) {
                        const count = btn.querySelector('.connection-count');
                        if (count) count.textContent = data.stats.total || 0;
                    }
                } catch (e) { console.error('Error updating connection count:', e); }
            }

            // Update every 5 seconds
            setInterval(updateConnectionCount, 5000);
            updateConnectionCount();

            // --- Timeline & Inactivity Logic ---

            function resetInactivityTimer() {
                const container = document.getElementById('playerContainer');
                if (!container) return;

                container.classList.add('user-active');
                clearTimeout(inactivityTimeout);

                inactivityTimeout = setTimeout(() => {
                    hideControls();
                }, 2000);
            }

            function hideControls() {
                const container = document.getElementById('playerContainer');
                if (container) {
                    container.classList.remove('user-active');
                    clearTimeout(inactivityTimeout);
                }
            }

            function formatTime(seconds) {
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `${m}:${s.toString().padStart(2, '0')}`;
            }

            function initTimeline() {
                const video = document.getElementById('videoPlayer');
                const range = document.getElementById('videoTimeline');
                const durationDisplay = document.getElementById('duration');

                if (video && range) {
                    range.max = video.duration;
                    durationDisplay.textContent = formatTime(video.duration);
                }
            }

            function updateTimeline() {
                const video = document.getElementById('videoPlayer');
                const range = document.getElementById('videoTimeline');
                const currentDisplay = document.getElementById('currentTime');

                if (video && range) {
                    range.value = video.currentTime;
                    currentDisplay.textContent = formatTime(video.currentTime);
                }
            }

            function seekTo(value) {
                const video = document.getElementById('videoPlayer');
                if (video) {
                    video.currentTime = value;
                    resetInactivityTimer();
                }
            }

            // --- Rating System Logic ---
            let currentRating = 0;

            function onVideoEnded() {
                // Video finished! Show "How did it go?" modal
                const modal = document.getElementById('ratingModal');
                if (modal) {
                    modal.style.display = 'flex';

                    // Reset fields
                    currentRating = 0;
                    document.getElementById('ratingComment').value = '';
                    updateStars(0);

                    // Exit fullscreen if active
                    if (document.fullscreenElement) {
                        document.exitFullscreen().catch(err => console.log(err));
                    }
                }
            }

            function setRating(rating) {
                currentRating = rating;
                updateStars(rating);
            }

            function updateStars(rating) {
                const stars = document.querySelectorAll('.star-rating span');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('active');
                        star.textContent = '‚òÖ'; // Filled star
                    } else {
                        star.classList.remove('active');
                        star.textContent = '‚òÜ'; // Empty star outline (optional, or just color change)
                    }
                });
            }

            async function submitRating() {
                if (currentRating === 0) {
                    alert('Please select a star rating properly.');
                    return;
                }

                const comment = document.getElementById('ratingComment').value;
                const studentName = localStorage.getItem('currentStudent') || 'Guest';

                // Get current video file name
                const currentVideo = currentProject.videos[currentVideoIndex];

                const payload = {
                    student: studentName,
                    project: currentProject.name,
                    file: currentVideo,
                    rating: currentRating,
                    comment: comment
                };

                try {
                    const btn = document.querySelector('.submit-rating-btn');
                    const originalText = btn.textContent;
                    btn.textContent = 'Saving...';
                    btn.disabled = true;

                    const response = await fetch('/api/ratings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error('Failed to save rating');

                    // Success!
                    btn.textContent = 'Saved!';

                    setTimeout(() => {
                        // Hide modal
                        document.getElementById('ratingModal').style.display = 'none';
                        btn.textContent = originalText;
                        btn.disabled = false;

                        // Auto-advance to next video if available
                        if (currentVideoIndex < currentProject.videos.length - 1) {
                            nextVideo();
                        }
                    }, 500);

                } catch (error) {
                    console.error('Error submitting rating:', error);
                    alert('Failed to save rating locally. Proceeding anyway.');
                    document.getElementById('ratingModal').style.display = 'none';
                }
            }

            // --- New Player Controls ---
            function setPlaybackSpeed(speed) {
                const video = document.getElementById('videoPlayer');
                if (video) {
                    video.playbackRate = parseFloat(speed);
                }
            }

            function toggleFullscreen() {
                const container = document.getElementById('playerContainer');
                if (!document.fullscreenElement) {
                    if (container.requestFullscreen) {
                        container.requestFullscreen();
                    } else if (container.mozRequestFullScreen) { /* Firefox */
                        container.mozRequestFullScreen();
                    } else if (container.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
                        container.webkitRequestFullscreen();
                    } else if (container.msRequestFullscreen) { /* IE/Edge */
                        container.msRequestFullscreen();
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            }
        </script>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            // WebSocket connection for remote control
            const socket = io();

            socket.on('connect', () => {
                console.log('Connected to server via WebSocket');

                // Send student name if logged in
                const currentStudent = localStorage.getItem('currentStudent');
                if (currentStudent) {
                    socket.emit('student-login', { studentName: currentStudent });
                }

                // Notify server of current page
                const projectName = currentProject ? currentProject.name : 'Unknown Project';
                socket.emit('page-change', { page: `Project: ${projectName}` });
            });

            // Listen for navigation commands from teacher
            socket.on('navigate', (data) => {
                console.log('Navigation command received:', data.url);
                window.location.href = data.url;
            });
        </script>

        <a href="/connections.html" target="_blank" class="connection-monitor-btn" id="connectionBtn">
            <span>üåê Connections</span>
            <span class="connection-count">0</span>
        </a>

    </div> <!-- Close page-content -->

    <!-- Footer (hidden - now injected dynamically) -->
    <footer class="footer" style="display: none !important;">
        <div class="footer-content">
            <p>Last Updated: <span id="last-updated"></span></p>
            <p>&copy; 2026 LearnToBot. All rights reserved.</p>
            <p>
                <a href="#">Privacy Policy</a> |
                <a href="#">Terms of Service</a> |
                <a href="#">Help Center</a>
            </p>
        </div>
    </footer>
    <style>
        .footer {
            display: block !important;
            visibility: visible !important;
            text-align: center;
            padding: 30px 20px;
            margin-top: 40px;
            font-size: 0.9em;
            color: #9CA3AF;
            background: rgba(7, 31, 78, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 10;
            width: 100%;
        }

        .footer p {
            margin: 8px 0;
        }

        .footer a {
            color: #3B82F6;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const lastUpdatedElement = document.getElementById('last-updated');
            if (lastUpdatedElement) {
                const now = new Date();
                lastUpdatedElement.textContent = now.toLocaleString();
            }
        });
    </script>
    <script src="mode-indicator.js"></script>

    <script src="mobile-nav.js"></script>
</body>

</html>