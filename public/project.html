<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnToBot Class - Project</title>
    <link rel="stylesheet" href="kids-theme.css">
    <link rel="stylesheet" href="mobile.css">
    <script src="analytics.js"></script> <!-- Analytics Telemetry -->
    <style>
        /* Styles delegated to kids-theme.css */
        .video-player-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: var(--ltb-border-radius);
            overflow: hidden;
            margin-bottom: 30px;
        }

        /* Keep only page-specific layout that isn't in theme */
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">
                <span class="navbar-logo">ü§ñ</span>
                <span>LearnToBot</span>
            </a>

            <!-- Hamburger Button (Mobile Only) -->
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>

            <ul class="navbar-menu" id="mobileMenu">
                <li><a href="/" class="navbar-link active">Projects</a></li>
                <li><a href="/child-progress.html" class="navbar-link">Student Progress</a></li>
                <li><a href="/prizes.html" class="navbar-link">Prizes</a></li>
                <li><a href="/leaderboard.html" class="navbar-link">Leaders</a></li>
                <li><a href="/instructor-dashboard.html" class="navbar-link">Teacher Panel</a></li>
                <li><a href="/instructor-dashboard.html?tab=analytics" class="navbar-link">Analytics</a></li>
                <li><a href="/all-kids.html" class="navbar-link">All Kids</a></li>
            </ul>

            <div class="navbar-auth">
                <a href="/" class="navbar-btn">Back to Projects</a>
            </div>
        </div>
    </nav>

    <script>
        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('mobile-open');
        }
    </script>

    <div class="page-content">
        <div class="header">
            <h1 class="project-title" id="projectTitle">Loading...</h1>
            <button class="pdf-btn" id="pdfBtn" onclick="togglePDF()" style="display: none;">üìÑ View
                Instructions</button>
        </div>

        <div id="content">
            <!-- Dynamic Content will be loaded here -->
            <div class="loading">Loading project...</div>
        </div>

        <script>
            // ... (keeping existing variables) ...
            let currentProject = null;
            let currentVideoIndex = 0;
            let inactivityTimeout;

            // ========================================================================
            // DEPLOYMENT MODE - Fetched from server's environment variable
            // ========================================================================
            let DEPLOYMENT_MODE = 'offline'; // Default

            async function fetchDeploymentMode() {
                try {
                    const response = await fetch('/api/config');
                    const config = await response.json();
                    DEPLOYMENT_MODE = config.deploymentMode || 'offline';
                    console.log(`[Project Page] Deployment mode: ${DEPLOYMENT_MODE} (from server)`);
                } catch (error) {
                    console.warn('[Project Page] Could not fetch config, defaulting to offline mode');
                    DEPLOYMENT_MODE = 'offline';
                }
            }

            // Get project ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');

            // Initialize the page
            (async function init() {
                await fetchDeploymentMode();
                if (!projectId) {
                    showError('No project ID specified');
                } else {
                    loadProject();
                }
            })();

            async function loadProject() {
                try {
                    // ========================================================================
                    // ONLINE MODE: Fetch project info and parts from Google Sheets
                    // ========================================================================
                    if (DEPLOYMENT_MODE === 'online') {
                        console.log('Loading project from Google Sheets (Online Mode)...');

                        // Fetch project details
                        const projectsResp = await fetch('/api/all-projects');
                        const projectsData = await projectsResp.json();

                        if (!projectsData.success) {
                            showError('Failed to load projects: ' + (projectsData.error || 'Unknown error'));
                            return;
                        }

                        // Find the project by ID
                        const projectInfo = projectsData.projects.find(p => p.id === projectId.toUpperCase());

                        if (!projectInfo) {
                            showError('Project not found: ' + projectId);
                            return;
                        }

                        // Fetch parts/videos for this project
                        const partsResp = await fetch(`/api/project-parts/${projectId}`);
                        const partsData = await partsResp.json();

                        if (!partsData.success) {
                            showError('Failed to load project parts: ' + (partsData.error || 'Unknown error'));
                            return;
                        }

                        // Build currentProject object compatible with existing displayProject()
                        currentProject = {
                            id: projectInfo.id,
                            name: projectInfo.name || projectInfo.id,
                            description: projectInfo.description || '',
                            category: projectInfo.category || '',
                            // Convert parts to videos array (YouTube URLs)
                            videos: partsData.parts.map(part => part.youtubeUrl),
                            // Store full parts data for filmstrip
                            parts: partsData.parts,
                            // No PDF in online mode
                            pdf: null,
                            icon: null,
                            videoCount: partsData.count
                        };

                        console.log(`Loaded project ${currentProject.name} with ${currentProject.videos.length} videos`);
                        displayProject();
                        return;
                    }

                    // ========================================================================
                    // OFFLINE MODE: Fetch from local project folders (original behavior)
                    // ========================================================================
                    const response = await fetch('/api/projects');
                    const data = await response.json();

                    if (data.error) { showError(data.error); return; }

                    currentProject = data.projects.find(p => p.id === projectId);

                    if (!currentProject) { showError('Project not found: ' + projectId); return; }

                    displayProject();
                } catch (error) {
                    showError('Failed to load project: ' + error.message);
                }
            }

            function displayProject() {
                document.getElementById('projectTitle').textContent = currentProject.name;

                // ========================================================================
                // ONLINE MODE: Simple YouTube player with part cards below
                // ========================================================================
                if (DEPLOYMENT_MODE === 'online') {
                    displayProjectOnline();
                    return;
                }

                // ========================================================================
                // OFFLINE MODE: Original immersive player layout (unchanged)
                // ========================================================================
                if (currentProject.pdf) {
                    document.getElementById('pdfBtn').style.display = 'block';
                }

                // Create the Immersive Player Layout
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="container">
                        
                        <!-- Main Player Container -->
                        <div class="video-player-container" id="playerContainer" onmousemove="resetInactivityTimer()" onmouseleave="hideControls()">
                            <video id="videoPlayer" onclick="togglePlay()" ontimeupdate="updateTimeline()" onloadedmetadata="initTimeline()" onended="onVideoEnded()">
                                Your browser does not support the video tag.
                            </video>
                            
                            <!-- Centered Overlay Controls -->
                            <div class="controls-overlay" onclick="togglePlay()">
                                <div class="kid-controls-centered" onclick="event.stopPropagation()">
                                    <button class="big-btn" onclick="seek(-10)" title="Rewind 10s">
                                        ‚è™ 10
                                    </button>
                                    
                                    <button class="big-btn play-btn" id="overlayPlayBtn" onclick="togglePlay()" title="Play/Pause">
                                        ‚ñ∂Ô∏è
                                    </button>
                                    
                                    <button class="big-btn" onclick="seek(10)" title="Forward 10s">
                                        10 ‚è©
                                    </button>
                                </div>
                            </div>

                            <!-- Timeline Bar -->
                            <div class="timeline-container" onclick="event.stopPropagation()">
                                <span id="currentTime" class="time-display">0:00</span>
                                <input type="range" id="videoTimeline" min="0" value="0" step="0.1" oninput="seekTo(this.value)">
                                <span id="duration" class="time-display">0:00</span>
                                
                                <select onchange="setPlaybackSpeed(this.value)" style="background:transparent; color:white; border:1px solid rgba(255,255,255,0.3); border-radius:5px; padding:5px; margin-left:10px; cursor:pointer;">
                                    <option value="1" style="color:black;">1x</option>
                                    <option value="1.5" style="color:black;">1.5x</option>
                                    <option value="2" style="color:black;">2x</option>
                                </select>
                                
                                <button onclick="toggleFullscreen()" style="background:transparent; border:none; color:white; font-size:1.5em; cursor:pointer; margin-left:10px;" title="Fullscreen">
                                    ‚õ∂
                                </button>
                            </div>

                            <!-- Bottom Filmstrip Overlay -->
                            <div class="filmstrip-overlay">
                                <div class="filmstrip-track" id="filmstripTrack">
                                    <!-- Filmstrip items will be injected here -->
                                </div>
                            </div>

                            <!-- Rating Modal (Overlay) -->
                            <div class="rating-modal" id="ratingModal" style="display: none;">
                                <div class="rating-content">
                                    <div class="rating-title">How did it go?</div>
                                    <div class="star-rating" id="starRating">
                                        <span onclick="setRating(1)">‚òÖ</span>
                                        <span onclick="setRating(2)">‚òÖ</span>
                                        <span onclick="setRating(3)">‚òÖ</span>
                                        <span onclick="setRating(4)">‚òÖ</span>
                                        <span onclick="setRating(5)">‚òÖ</span>
                                    </div>
                                    <textarea class="rating-comment" id="ratingComment" rows="3" placeholder="Any comments? (Optional)"></textarea>
                                    <button class="submit-rating-btn" onclick="submitRating()">Submit & Continue</button>
                                </div>
                            </div>
                        </div>

                        <!-- Global Navigation (Outside player) -->
                        <div class="global-nav">
                            <button class="control-btn" id="prevBtn" onclick="previousVideo()">‚èÆ Previous Video</button>
                            <div style="color: #9CA3AF; font-weight: bold; align-self: center;" id="videoCounter">1 / ${currentProject.videos.length}</div>
                            <button class="control-btn" id="nextBtn" onclick="nextVideo()">Next Video ‚è≠</button>
                        </div>
                        
                        <!-- PDF Viewer Container (Initially Hidden) -->
                        ${currentProject.pdf ? `
                        <div class="pdf-viewer" id="pdfViewer" style="display: none; width: 100%; max-width: 1200px; margin-top: 30px;">
                            <div class="pdf-viewer-header">
                                <div class="pdf-viewer-title">üìÑ Project Instructions</div>
                                <button class="close-pdf-btn" onclick="togglePDF()">‚úï Close</button>
                            </div>
                            <iframe class="pdf-embed" src="/projects/${encodeURIComponent(currentProject.id)}/${encodeURIComponent(currentProject.pdf)}"></iframe>
                        </div>` : ''}

                    </div>
                `;

                renderFilmstrip();
                playVideo(0);

                // Add Event Listeners for Play/Pause Button Toggle
                const videoElement = document.getElementById('videoPlayer');
                videoElement.addEventListener('play', updatePlayButton);
                videoElement.addEventListener('pause', updatePlayButton);
                updatePlayButton(); // Initial state
            }

            // ========================================================================
            // ONLINE MODE DISPLAY: Clean YouTube player + Part Cards
            // ========================================================================
            function displayProjectOnline() {
                const content = document.getElementById('content');
                const parts = currentProject.parts || [];

                // Build part cards HTML
                const partCardsHTML = parts.map((part, index) => {
                    const coverImage = part.coverImage || `https://img.youtube.com/vi/${extractVideoId(part.youtubeUrl)}/hqdefault.jpg`;
                    const title = part.partTitle || `Part ${index + 1}`;
                    const duration = part.duration || '';

                    return `
                        <div class="part-card ${index === 0 ? 'active' : ''}" onclick="playOnlinePart(${index})" data-index="${index}">
                            <div class="part-card-thumb">
                                <img src="${coverImage}" alt="${title}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22160%22 height=%2290%22><rect fill=%22%231F2937%22 width=%22160%22 height=%2290%22/><text fill=%22%23fff%22 x=%2280%22 y=%2250%22 text-anchor=%22middle%22 font-size=%2230%22>üé•</text></svg>'">
                                <span class="part-card-number">${index + 1}</span>
                                ${duration ? `<span class="part-card-duration">${duration}</span>` : ''}
                            </div>
                            <div class="part-card-title">${title}</div>
                        </div>
                    `;
                }).join('');

                content.innerHTML = `
                    <style>
                        .online-player-container {
                            width: 100%;
                            max-width: 1000px;
                            margin: 0 auto;
                        }
                        .youtube-frame {
                            width: 100%;
                            aspect-ratio: 16/9;
                            border-radius: 15px;
                            overflow: hidden;
                            background: #000;
                            margin-bottom: 20px;
                        }
                        .youtube-frame iframe {
                            width: 100%;
                            height: 100%;
                            border: none;
                        }
                        .online-nav {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 25px;
                            padding: 0 10px;
                        }
                        .online-nav-btn {
                            background: #374151;
                            color: white;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 25px;
                            cursor: pointer;
                            font-weight: 600;
                            transition: all 0.2s;
                        }
                        .online-nav-btn:hover:not(:disabled) {
                            background: #3B82F6;
                            transform: translateY(-2px);
                        }
                        .online-nav-btn:disabled {
                            opacity: 0.4;
                            cursor: not-allowed;
                        }
                        .online-counter {
                            font-size: 1.2em;
                            font-weight: bold;
                            color: #9CA3AF;
                        }
                        .parts-section {
                            margin-top: 20px;
                        }
                        .parts-title {
                            color: #E5E7EB;
                            font-size: 1.1em;
                            margin-bottom: 15px;
                            font-weight: 600;
                        }
                        .parts-grid {
                            display: flex;
                            gap: 15px;
                            overflow-x: auto;
                            padding-bottom: 10px;
                            scrollbar-width: thin;
                            scrollbar-color: #3B82F6 transparent;
                        }
                        .parts-grid::-webkit-scrollbar {
                            height: 8px;
                        }
                        .parts-grid::-webkit-scrollbar-thumb {
                            background: #3B82F6;
                            border-radius: 8px;
                        }
                        .part-card {
                            flex: 0 0 180px;
                            background: #1F2937;
                            border-radius: 12px;
                            overflow: hidden;
                            cursor: pointer;
                            border: 2px solid transparent;
                            transition: all 0.2s;
                        }
                        .part-card:hover {
                            border-color: #3B82F6;
                            transform: translateY(-3px);
                        }
                        .part-card.active {
                            border-color: #10B981;
                            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
                        }
                        .part-card-thumb {
                            position: relative;
                            width: 100%;
                            aspect-ratio: 16/9;
                            background: #374151;
                        }
                        .part-card-thumb img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        }
                        .part-card-number {
                            position: absolute;
                            top: 8px;
                            left: 8px;
                            background: #3B82F6;
                            color: white;
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 0.8em;
                            font-weight: bold;
                        }
                        .part-card-duration {
                            position: absolute;
                            bottom: 8px;
                            right: 8px;
                            background: rgba(0,0,0,0.8);
                            color: white;
                            padding: 2px 6px;
                            border-radius: 4px;
                            font-size: 0.75em;
                        }
                        .part-card-title {
                            padding: 10px;
                            color: #E5E7EB;
                            font-size: 0.9em;
                            text-align: center;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        }
                    </style>
                    
                    <div class="online-player-container">
                        <!-- YouTube Player -->
                        <div class="youtube-frame" id="youtubeFrame">
                            <iframe id="youtubePlayer" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                        
                        <!-- Navigation -->
                        <div class="online-nav">
                            <button class="online-nav-btn" id="prevBtn" onclick="playOnlinePart(currentVideoIndex - 1)">‚èÆ Previous</button>
                            <span class="online-counter" id="videoCounter">1 / ${parts.length}</span>
                            <button class="online-nav-btn" id="nextBtn" onclick="playOnlinePart(currentVideoIndex + 1)">Next ‚è≠</button>
                        </div>
                        
                        <!-- Part Cards -->
                        <div class="parts-section">
                            <div class="parts-title">üìπ Video Parts</div>
                            <div class="parts-grid" id="partsGrid">
                                ${partCardsHTML}
                            </div>
                        </div>
                    </div>
                `;

                // Play first video
                playOnlinePart(0);
            }

            // Helper to extract YouTube video ID
            function extractVideoId(url) {
                if (!url) return '';
                if (url.includes('youtu.be/')) {
                    return url.split('youtu.be/')[1].split('?')[0];
                } else if (url.includes('youtube.com/watch?v=')) {
                    return url.split('v=')[1].split('&')[0];
                }
                return url;
            }

            // Play a specific part (Online mode)
            function playOnlinePart(index) {
                const parts = currentProject.parts || [];
                if (index < 0 || index >= parts.length) return;

                currentVideoIndex = index;
                const part = parts[index];
                const videoId = extractVideoId(part.youtubeUrl);
                const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;

                // Update YouTube player
                const iframe = document.getElementById('youtubePlayer');
                if (iframe) {
                    iframe.src = embedUrl;
                }

                // Update counter
                const counter = document.getElementById('videoCounter');
                if (counter) {
                    counter.textContent = `${index + 1} / ${parts.length}`;
                }

                // Update navigation buttons
                document.getElementById('prevBtn').disabled = index === 0;
                document.getElementById('nextBtn').disabled = index === parts.length - 1;

                // Update active card styling
                document.querySelectorAll('.part-card').forEach((card, i) => {
                    card.classList.toggle('active', i === index);
                });
            }

            function renderFilmstrip() {
                const track = document.getElementById('filmstripTrack');

                // Check if we have parts data (Online mode) or just video URLs (Offline mode)
                const hasParts = currentProject.parts && currentProject.parts.length > 0;

                track.innerHTML = currentProject.videos.map((video, index) => {
                    // Get part info if available (Online mode)
                    const part = hasParts ? currentProject.parts[index] : null;

                    // Determine thumbnail
                    let thumbContent = '';
                    if (part && part.coverImage) {
                        // Use cover image from parts data (Online mode)
                        thumbContent = `<img src="${part.coverImage}" class="filmstrip-thumb" onerror="this.parentNode.innerHTML='<div style=\\'width:100%;height:100%;background:linear-gradient(45deg,#1F2937,#374151);display:flex;align-items:center;justify-content:center;font-size:2em\\'>üé•</div>'">`;
                    } else {
                        // Fallback to generic icon (Offline mode or no cover)
                        thumbContent = `<div style="width:100%; height:100%; background: linear-gradient(45deg, #1F2937, #374151); display:flex; align-items:center; justify-content:center; font-size:2em;">üé•</div>`;
                    }

                    // Determine title
                    let title = '';
                    if (part && part.partTitle) {
                        title = part.partTitle;
                    } else {
                        // Fallback to video filename for offline mode
                        title = video.split('/').pop();
                    }

                    return `
                    <div class="filmstrip-item ${index === currentVideoIndex ? 'active' : ''}" onclick="playVideo(${index})">
                        <div class="filmstrip-number">${index + 1}</div>
                        ${thumbContent}
                        <div class="filmstrip-title">${title}</div>
                    </div>
                    `;
                }).join('');
            }


            function playVideo(index) {
                if (index < 0 || index >= currentProject.videos.length) return;

                currentVideoIndex = index;
                const video = currentProject.videos[index];

                // Check if this is a YouTube URL
                const isYouTube = video.includes('youtu.be') || video.includes('youtube.com');

                if (isYouTube) {
                    // Convert YouTube URL to embed format
                    let videoId = '';
                    if (video.includes('youtu.be/')) {
                        videoId = video.split('youtu.be/')[1].split('?')[0];
                    } else if (video.includes('youtube.com/watch?v=')) {
                        videoId = video.split('v=')[1].split('&')[0];
                    }

                    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;

                    // Find or create video player area
                    let videoPlayer = document.getElementById('videoPlayer');
                    let youtubePlayer = document.getElementById('youtubePlayer');

                    if (youtubePlayer) {
                        // Just update the src
                        youtubePlayer.src = embedUrl;
                    } else if (videoPlayer) {
                        // Replace video element with YouTube iframe
                        videoPlayer.insertAdjacentHTML('afterend', `
                            <iframe 
                                id="youtubePlayer"
                                src="${embedUrl}"
                                style="width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0;"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen>
                            </iframe>
                        `);
                        videoPlayer.style.display = 'none';
                    } else {
                        // No player exists, create one in playerContainer
                        const container = document.getElementById('playerContainer');
                        const existingIframe = container.querySelector('iframe');
                        if (existingIframe) {
                            existingIframe.src = embedUrl;
                        } else {
                            container.insertAdjacentHTML('afterbegin', `
                                <iframe 
                                    id="youtubePlayer"
                                    src="${embedUrl}"
                                    style="width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0;"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                    allowfullscreen>
                                </iframe>
                            `);
                        }
                    }
                } else {
                    // Local video file - use HTML5 video player
                    // Encode each path segment separately
                    const projectIdSegments = currentProject.id.split('/').map(seg => encodeURIComponent(seg)).join('/');
                    const videoSegments = video.split('/').map(seg => encodeURIComponent(seg)).join('/');
                    const videoPath = `/projects/${projectIdSegments}/${videoSegments}`;

                    // Use the video player
                    const player = document.getElementById('videoPlayer');
                    if (player) {
                        player.src = videoPath;
                    }
                }

                // Update active state in filmstrip
                renderFilmstrip();

                // Update global nav button states
                document.getElementById('prevBtn').disabled = index === 0;
                document.getElementById('nextBtn').disabled = index === currentProject.videos.length - 1;

                // Update counter
                const counter = document.getElementById('videoCounter');
                if (counter) counter.textContent = `${index + 1} / ${currentProject.videos.length}`;

                // Update play button state (reset to pause icon on new video load)
                updatePlayButton();
            }

            function previousVideo() {
                playVideo(currentVideoIndex - 1);
            }

            function nextVideo() {
                playVideo(currentVideoIndex + 1);
            }

            // ... (keep PDF toggle) ...

            // ... (keep showError) ...

            // ... (keep DOMContentLoaded / shortcuts) ...

            function togglePlay() {
                const video = document.getElementById('videoPlayer');
                if (video.paused) {
                    video.play();
                } else {
                    video.pause();
                }
                updatePlayButton();
            }

            function updatePlayButton() {
                const video = document.getElementById('videoPlayer');
                const btn = document.getElementById('overlayPlayBtn');

                if (!video || !btn) return;

                if (video.paused) {
                    btn.textContent = '‚ñ∂Ô∏è';
                    btn.classList.remove('paused-state');
                } else {
                    btn.textContent = '‚è∏Ô∏è';
                    btn.classList.add('paused-state');
                }
            }

            function seek(seconds) {
                const video = document.getElementById('videoPlayer');
                video.currentTime += seconds;
            }

            function togglePDF() {
                const pdfViewer = document.getElementById('pdfViewer');
                if (!pdfViewer) return;

                if (pdfViewer.style.display === 'none') {
                    pdfViewer.style.display = 'block';
                    // Scroll to the viewer
                    setTimeout(() => {
                        pdfViewer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                } else {
                    pdfViewer.style.display = 'none';
                }
            }

            // Update connection count
            async function updateConnectionCount() {
                try {
                    const response = await fetch('/api/connections');
                    const data = await response.json();
                    const btn = document.getElementById('connectionBtn');
                    if (btn && data.stats) {
                        const count = btn.querySelector('.connection-count');
                        if (count) count.textContent = data.stats.total || 0;
                    }
                } catch (e) { console.error('Error updating connection count:', e); }
            }

            // Update every 5 seconds
            setInterval(updateConnectionCount, 5000);
            updateConnectionCount();

            // --- Timeline & Inactivity Logic ---

            function resetInactivityTimer() {
                const container = document.getElementById('playerContainer');
                if (!container) return;

                container.classList.add('user-active');
                clearTimeout(inactivityTimeout);

                inactivityTimeout = setTimeout(() => {
                    hideControls();
                }, 2000);
            }

            function hideControls() {
                const container = document.getElementById('playerContainer');
                if (container) {
                    container.classList.remove('user-active');
                    clearTimeout(inactivityTimeout);
                }
            }

            function formatTime(seconds) {
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `${m}:${s.toString().padStart(2, '0')}`;
            }

            function initTimeline() {
                const video = document.getElementById('videoPlayer');
                const range = document.getElementById('videoTimeline');
                const durationDisplay = document.getElementById('duration');

                if (video && range) {
                    range.max = video.duration;
                    durationDisplay.textContent = formatTime(video.duration);
                }
            }

            function updateTimeline() {
                const video = document.getElementById('videoPlayer');
                const range = document.getElementById('videoTimeline');
                const currentDisplay = document.getElementById('currentTime');

                if (video && range) {
                    range.value = video.currentTime;
                    currentDisplay.textContent = formatTime(video.currentTime);
                }
            }

            function seekTo(value) {
                const video = document.getElementById('videoPlayer');
                if (video) {
                    video.currentTime = value;
                    resetInactivityTimer();
                }
            }

            // --- Rating System Logic ---
            let currentRating = 0;

            function onVideoEnded() {
                // Video finished! Show "How did it go?" modal
                const modal = document.getElementById('ratingModal');
                if (modal) {
                    modal.style.display = 'flex';

                    // Reset fields
                    currentRating = 0;
                    document.getElementById('ratingComment').value = '';
                    updateStars(0);

                    // Exit fullscreen if active
                    if (document.fullscreenElement) {
                        document.exitFullscreen().catch(err => console.log(err));
                    }
                }
            }

            function setRating(rating) {
                currentRating = rating;
                updateStars(rating);
            }

            function updateStars(rating) {
                const stars = document.querySelectorAll('.star-rating span');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('active');
                        star.textContent = '‚òÖ'; // Filled star
                    } else {
                        star.classList.remove('active');
                        star.textContent = '‚òÜ'; // Empty star outline (optional, or just color change)
                    }
                });
            }

            async function submitRating() {
                if (currentRating === 0) {
                    alert('Please select a star rating properly.');
                    return;
                }

                const comment = document.getElementById('ratingComment').value;
                const studentName = localStorage.getItem('currentStudent') || 'Guest';

                // Get current video file name
                const currentVideo = currentProject.videos[currentVideoIndex];

                const payload = {
                    student: studentName,
                    project: currentProject.name,
                    file: currentVideo,
                    rating: currentRating,
                    comment: comment
                };

                try {
                    const btn = document.querySelector('.submit-rating-btn');
                    const originalText = btn.textContent;
                    btn.textContent = 'Saving...';
                    btn.disabled = true;

                    const response = await fetch('/api/ratings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error('Failed to save rating');

                    // Success!
                    btn.textContent = 'Saved!';

                    setTimeout(() => {
                        // Hide modal
                        document.getElementById('ratingModal').style.display = 'none';
                        btn.textContent = originalText;
                        btn.disabled = false;

                        // Auto-advance to next video if available
                        if (currentVideoIndex < currentProject.videos.length - 1) {
                            nextVideo();
                        }
                    }, 500);

                } catch (error) {
                    console.error('Error submitting rating:', error);
                    alert('Failed to save rating locally. Proceeding anyway.');
                    document.getElementById('ratingModal').style.display = 'none';
                }
            }

            // --- New Player Controls ---
            function setPlaybackSpeed(speed) {
                const video = document.getElementById('videoPlayer');
                if (video) {
                    video.playbackRate = parseFloat(speed);
                }
            }

            function toggleFullscreen() {
                const container = document.getElementById('playerContainer');
                if (!document.fullscreenElement) {
                    if (container.requestFullscreen) {
                        container.requestFullscreen();
                    } else if (container.mozRequestFullScreen) { /* Firefox */
                        container.mozRequestFullScreen();
                    } else if (container.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
                        container.webkitRequestFullscreen();
                    } else if (container.msRequestFullscreen) { /* IE/Edge */
                        container.msRequestFullscreen();
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            }
        </script>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            // WebSocket connection for remote control
            const socket = io();

            socket.on('connect', () => {
                console.log('Connected to server via WebSocket');

                // Send student name if logged in
                const currentStudent = localStorage.getItem('currentStudent');
                if (currentStudent) {
                    socket.emit('student-login', { studentName: currentStudent });
                }

                // Notify server of current page
                const projectName = currentProject ? currentProject.name : 'Unknown Project';
                socket.emit('page-change', { page: `Project: ${projectName}` });
            });

            // Listen for navigation commands from teacher
            socket.on('navigate', (data) => {
                console.log('Navigation command received:', data.url);
                window.location.href = data.url;
            });
        </script>

        <a href="/connections.html" target="_blank" class="connection-monitor-btn" id="connectionBtn">
            <span>üåê Connections</span>
            <span class="connection-count">0</span>
        </a>

    </div> <!-- Close page-content -->
    <footer>
        <p>Last Updated: <span id="last-updated"></span></p>
    </footer>
    <style>
        footer {
            text-align: center;
            padding: 1rem;
            margin-top: 2rem;
            font-size: 0.9em;
            color: #6c757d;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const lastUpdatedElement = document.getElementById('last-updated');
            if (lastUpdatedElement) {
                const now = new Date();
                lastUpdatedElement.textContent = now.toLocaleString();
            }
        });
    </script>
    <script src="mode-indicator.js"></script>
    <script src="mobile-nav.js"></script>
</body>

</html>