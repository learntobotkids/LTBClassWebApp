<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Instructor Dashboard</title>
    <script src="analytics.js"></script> <!-- Analytics Telemetry -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js Visualization -->
    <!-- Use standard font similar to screenshot -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- CUSTOM DROPDOWN STYLES --- */
        .custom-select-container {
            position: relative;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            /* Base font size explicitly set */
        }

        .custom-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            /* Bigger padding for touch */
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            font-size: 18px;
            /* Bigger Text Request */
            color: #333;
            font-weight: 500;
        }

        .custom-select-trigger:hover {
            border-color: #bbbbbb;
            background: #fafafa;
        }

        .custom-select-trigger .arrow {
            color: #666;
            transition: transform 0.2s;
        }

        .custom-select-container.open .custom-select-trigger {
            border-color: #4ECDC4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
        }

        .custom-select-container.open .arrow {
            transform: rotate(180deg);
        }

        .custom-select-options {
            position: absolute;
            top: 110%;
            /* Slight gap */
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #eee;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-height: 350px;
            /* Taller scroll area */
            overflow-y: auto;
            z-index: 3000;
            /* Ensure above modal */
            display: none;
            scrollbar-width: thin;
        }

        .custom-select-container.open .custom-select-options {
            display: block;
            animation: fadeIn 0.15s ease-out;
        }

        .custom-select-optgroup {
            padding: 12px 16px 5px;
            font-size: 13px;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #fdfdfd;
            position: sticky;
            top: 0;
        }

        .custom-select-option {
            padding: 16px 20px;
            /* Generous touch target */
            font-size: 17px;
            color: #333;
            border-bottom: 1px solid #f5f5f5;
            transition: background 0.1s;
        }

        .custom-select-option:last-child {
            border-bottom: none;
        }

        .custom-select-option:hover {
            background-color: #f0fdfc;
            /* Light teal tint */
            color: #2c7a7b;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- UPDATED CSS FOR MINIMALIST DESIGN --- */

        body {
            /* Apple-system font stack for that native feel */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            padding: 0;
            background-color: #F8F9FA;
            /* Slightly cleaner white/grey */
            padding-top: 60px;
            /* Space for fixed header */
            padding-bottom: 70px;
            /* Space for fixed footer */
            color: #1F2937;
        }

        /* --- HEADER --- */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            /* Site Theme Gradient */
            background: linear-gradient(180deg, #292E49 0%, #536976 100%);
            /* Teal Border */
            border-bottom: 4px solid #4ECDC4;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-icon {
            font-size: 24px;
            cursor: pointer;
        }

        .app-logo {
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 50%;
            padding: 2px;
        }

        .app-logo img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .header-title {
            font-size: 20px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .header-right {
            display: flex;
            gap: 20px;
        }

        .header-icon {
            font-size: 24px;
            cursor: pointer;
        }

        .logout-icon {
            font-size: 20px;
            cursor: pointer;
            color: #FF6B6B;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }

        .logout-icon:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* --- CONTENT AREA --- */
        .content-area {
            width: 100%;
            max-width: 600px;
            /* Limit width on desktop */
            margin: 0 auto;
        }

        /* --- NEW CARD STYLES --- */
        .student-card {
            background: white;
            padding: 12px 20px;
            /* More horizontal breathing room */
            display: flex;
            align-items: center;
            border-bottom: 1px solid #E5E7EB;
            /* Very light subtle border */
            min-height: 72px;
            /* Consistent height like iOS list items */
        }

        .student-initial-fallback {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #E5E7EB;
            /* Light grey */
            color: #4B5563;
            /* Darker grey text */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            /* Semi-bold */
            margin-right: 16px;
            flex-shrink: 0;
        }

        .student-headshot {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 16px;
            flex-shrink: 0;
            border: 1px solid #eee;
        }

        .student-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
            /* Text truncation fix */
        }

        .student-name {
            font-size: 16px;
            font-weight: 600;
            /* Apple style bold but not heavy */
            color: #111827;
            /* Near black */
            margin-bottom: 2px;
        }

        .student-project {
            font-size: 14px;
            color: #6B7280;
            /* Cool grey for secondary text */
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .attendance-actions {
            display: flex;
            align-items: center;
            gap: 16px;
            /* Space between icons */
            margin-left: 12px;
        }

        /* Action Buttons */
        .icon-btn {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .icon-btn:active {
            background-color: #f3f4f6;
        }

        .icon-img {
            width: 24px;
            height: 24px;
            opacity: 0.7;
        }

        /* Checkbox Style for "Today" view */
        .check-btn {
            width: 32px;
            height: 32px;
            background: #22C55E;
            /* Green */
            border-radius: 6px;
            /* Rounded square */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            border: none;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .check-btn.unchecked {
            background: #E5E7EB;
            color: transparent;
        }

        /* Warning Icon for absent/issue */
        .warning-icon {
            color: #BDBDBD;
            font-size: 30px;
        }



        /* --- FOOTER TABS --- */
        .footer-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: #db3236;
            /* Using same red for active, based on request/screenshot interpretation or maybe white? Screenshot usually has white/dark footer. User said "persistent footer... selectable from bottom". Let's assume a standard tab bar look. Usually white bg with icons. */
            background: white;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #757575;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            text-transform: uppercase;
        }

        .tab-item.active {
            color: #db3236;
        }

        .tab-icon {
            font-size: 24px;
            margin-bottom: 2px;
        }

        /* Loading State */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #666;
        }

        /* Empty State */
        .empty-state {
            padding: 40px;
            text-align: center;
            color: #888;
        }

        /* --- ANALYTICS DASHBOARD --- */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .analytics-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .analytics-stat {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
        }

        .analytics-label {
            font-size: 12px;
            color: #6B7280;
            text-transform: uppercase;
            font-weight: 600;
        }

        .chart-section {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
            border-bottom: 1px solid #f3f4f6;
            padding-bottom: 10px;
        }

        .activity-feed-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .feed-item {
            padding: 10px 0;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .feed-time {
            color: #9CA3AF;
            font-size: 11px;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        /* --- SPINNER --- */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #6B7280;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- ICONS SVG --- */
        /* Using inline SVG for simplicity and performance */
    </style>
</head>

<body>

    <!-- HEADER -->
    <!-- HEADER -->
    <header class="app-header">
        <div class="header-left">
            <div class="header-title" id="pageTitle" style="margin-left: 15px;">TODAY</div>
        </div>
        <div class="header-right">
            <button onclick="loadData()"
                style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 6px 12px; border-radius: 8px; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; margin-right: 10px;">
                <span>üîÑ</span> Refresh
            </button>
            <button onclick="logout()"
                style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 6px 12px; border-radius: 8px; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                <span>üö™</span> Logout
            </button>
        </div>
    </header>

    <script>
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('instructorName');
                localStorage.removeItem('instructorPasscode');
                window.location.href = '/';
            }
        }
    </script>

    <!-- MAIN CONTENT -->
    <div class="content-area" id="mainContent">
        <!-- Content injected via JS -->
    </div>

    <!-- FAB REMOVED -->

    <!-- STUDENT DETAIL OVERLAY (Initially Hidden) -->
    <div id="studentDetailView"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:#f8f9fa; z-index:2000; overflow-y:auto; padding-bottom: 70px;">
        <!-- Content injected by JS -->
    </div>

    <!-- INSTRUCTOR LOGIN MODAL -->
    <div id="instructorLoginModal"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:3000; align-items:center; justify-content:center;">
        <div
            style="background:white; padding:30px; border-radius:12px; width:90%; max-width:400px; text-align:center; box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
            <div style="font-size:40px; margin-bottom:15px;">üîí</div>
            <h2 style="margin-top:0; color:#333;">Instructor Access</h2>
            <p style="color:#666; margin-bottom:20px;">Select your name and enter passcode to access.</p>

            <select id="instructorNameSelect"
                style="width:100%; padding:12px; font-size:16px; border:2px solid #ddd; border-radius:8px; outline:none; margin-bottom:15px; background:white;">
                <option value="" disabled selected>Select Instructor...</option>
                <option value="Lead Instructor">Lead Instructor</option>
                <option value="Assistant Instructor">Assistant Instructor</option>
                <option value="Guest Instructor">Guest Instructor</option>
            </select>

            <input type="password" id="instructorPasscode" placeholder="Enter Passcode"
                onkeypress="if(event.key === 'Enter') submitInstructorLogin()"
                style="width:100%; padding:12px; font-size:16px; border:2px solid #ddd; border-radius:8px; outline:none; margin-bottom:20px; text-align:center;">

            <button onclick="submitInstructorLogin()"
                style="width:100%; background:#db3236; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; font-size:16px; cursor:pointer;">
                Unlock Dashboard
            </button>

            <div style="margin-top:15px;">
                <button onclick="window.location.href='/'"
                    style="background:none; border:none; color:#888; text-decoration:underline; cursor:pointer;">Back to
                    Home</button>
            </div>
        </div>
    </div>

    <!-- FOOTER TABS -->
    <nav class="footer-tabs">
        <div class="tab-item active" onclick="switchTab('today')">
            <div class="tab-icon">üìÖ</div>
            <div>TODAY</div>
        </div>
        <div class="tab-item" onclick="switchTab('all')">
            <div class="tab-icon">üë•</div>
            <div>ALL KIDS</div>
        </div>
        <!-- 
        <div class="tab-item" onclick="switchTab('report')">
            <div class="tab-icon">üìä</div>
            <div>CLASS REPORT</div>
        </div> 
        -->
        <!--
        <div class="tab-item" onclick="switchTab('analytics')">
            <div class="tab-icon">üìà</div>
            <div>ANALYTICS</div>
        </div>
        <div class="tab-item" onclick="switchTab('projects')">
            <div class="tab-icon">üìÅ</div>
            <div>PROJECTS</div>
        </div>
        -->
        <div class="tab-item" onclick="switchTab('leaderboard')">
            <div class="tab-icon">üèÜ</div>
            <div>LEADERS</div>
        </div>
        <div class="tab-item" onclick="switchTab('inventory')">
            <div class="tab-icon">üì¶</div>
            <div>INVENTORY</div>
        </div>

    </nav>

    <script>
        // State
        let currentTab = 'today';
        let studentsData = [];

        // Init
        // Init
        document.addEventListener('DOMContentLoaded', () => {
            checkLogin();

            // Deep Linking Check
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            if (tabParam && ['analytics', 'today', 'all', 'projects', 'leaderboard', 'inventory'].includes(tabParam)) {
                switchTab(tabParam);
            } else {
                loadData(); // Default load (initially fetches today data)
            }
        });

        // Local cache of valid instructors
        let validInstructors = [];

        function checkLogin() {
            if (localStorage.getItem('instructorLoggedIn') !== 'true') {
                // Show Login Modal
                showLoginModal();
            }
        }

        function logout() {
            localStorage.removeItem('instructorLoggedIn');
            localStorage.removeItem('instructorName');
            location.reload(); // Reload to show login modal again
        }

        async function showLoginModal() {
            const modal = document.getElementById('instructorLoginModal');
            if (modal) {
                modal.style.display = 'flex';

                // Fetch valid instructors
                try {
                    const res = await fetch('/api/instructors');
                    const data = await res.json();

                    if (data.success && data.instructors) {
                        validInstructors = data.instructors;
                        const select = document.getElementById('instructorNameSelect');

                        // Populate Dropdown
                        // Keep default option
                        let html = '<option value="" disabled selected>Select Instructor...</option>';
                        validInstructors.forEach(inst => {
                            html += `<option value="${inst.name}">${inst.name}</option>`;
                        });
                        select.innerHTML = html;
                    }
                } catch (e) {
                    console.error("Failed to load instructors", e);
                }

                // Focus input
                setTimeout(() => document.getElementById('instructorPasscode').focus(), 100);
            }
        }

        function submitInstructorLogin() {
            const nameSelect = document.getElementById('instructorNameSelect');
            const input = document.getElementById('instructorPasscode');
            const name = nameSelect.value;
            const pass = input.value;

            if (!name) {
                alert('Please select an instructor name.');
                return;
            }

            // Find instructor in loaded data
            const instructor = validInstructors.find(i => i.name === name);

            if (!instructor) {
                alert('Error: Instructor not found in validations list.');
                return;
            }

            // Validate Passcode
            if (pass.trim() === instructor.passcode.trim()) {
                localStorage.setItem('instructorLoggedIn', 'true');
                localStorage.setItem('instructorName', name);
                document.getElementById('instructorLoginModal').style.display = 'none';
                loadData();
            } else {
                alert('Incorrect passcode');
                input.value = '';
                input.focus();
            }
        }

        function switchTab(tab) {
            // Update UI
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            // Find component based on index or text
            // Updated order: Today, All, Analytics, Projects, Leaderboard, Inventory
            const index = ['today', 'all', 'analytics', 'projects', 'leaderboard', 'inventory'].indexOf(tab);
            if (index >= 0) {
                document.querySelectorAll('.tab-item')[index].classList.add('active');
            }

            currentTab = tab;

            // Update Header Title
            const titles = {
                'today': 'TODAY',
                'all': 'ALL STUDENTS',
                'analytics': 'ANALYTICS',
                'projects': 'PROJECTS',
                'leaderboard': 'LEADERBOARD',
                'inventory': 'INVENTORY'
            };
            document.getElementById('pageTitle').innerText = titles[tab] || 'LEARNTOBOT';

            // Re-render content
            render();
        }
        async function loadData() {
            const container = document.getElementById('mainContent');

            // Only show full loading if container is empty or we are forcing it? 
            // Better UX: keep old content while loading? For now, simple.
            if (!container.innerHTML || container.innerHTML.includes('empty-state')) {
                container.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div>Loading...</div>
                    </div>`;
            }

            try {
                // Fetch Today's Students
                console.log('Fetching /api/todays-students...');
                const response = await fetch('/api/todays-students');
                const data = await response.json();
                console.log('API Response:', data);

                if (data.success) {
                    studentsData = data.students;
                    console.log('Students Data loaded:', studentsData.length, 'records');
                    // Only re-render if we are on 'today' tab? Or just call render() which checks tab.
                    render();
                } else {
                    console.error('API Error:', data.error);
                }
            } catch (e) {
                console.error(e);
            }
        }

        function render() {
            const container = document.getElementById('mainContent');
            // Don't clear immediately if we want to preserve scroll? 
            // For simple implementation, clear is fine.
            container.innerHTML = '';

            if (currentTab === 'today') {
                renderToday(container);
            } else if (currentTab === 'all') {
                renderAllStudents(container);
            } else if (currentTab === 'leaderboard') {
                renderLeaderboard(container);
            } else if (currentTab === 'analytics') {
                renderAnalytics(container);
            } else if (currentTab === 'inventory') {
                renderInventory(container);
            } else {
                container.innerHTML = '<div class="empty-state">This page is empty for now.</div>';
            }
        }

        function renderHeadshot(url, name, studentId) {
            const initial = name ? name.charAt(0).toUpperCase() : '?';

            // Priority 1: Local File (Safe ID)
            // Priority 2: Remote URL (Fallback) - handled via src if ID missing
            // Priority 3: Initials (Fallback)

            let imgSrc = '';
            if (studentId) {
                const safeId = studentId.replace(/\//g, '_');
                imgSrc = `/headshots/${safeId}.jpg`;
            } else if (url) {
                imgSrc = url;
            }

            if (imgSrc) {
                // Escape URL to be safe in href/src but here we use it in src
                const safeUrl = imgSrc.replace(/'/g, "%27");

                return `
                    <div style="position: relative; width: 50px; height: 50px; margin-right: 16px;">
                         <img src="${safeUrl}" class="student-headshot" 
                              style="position: absolute; top:0; left:0; width:100%; height:100%; margin:0;" 
                              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                         <div class="student-initial-fallback" style="display:none; width:100%; height:100%; margin:0;">${initial}</div>
                    </div>
                `;
            }
            return `<div class="student-initial-fallback">${initial}</div>`;
        }

        let todaySearchTerm = '';
        let selectedServiceGroup = null;

        function renderToday(container) {
            // Setup Structure if not exists
            const wrapperId = 'today-view-wrapper';

            // Note: Clear and rebuild container to handle view switching cleanly
            container.innerHTML = `<div id="${wrapperId}" style="height: 100%; display: flex; flex-direction: column;"></div>`;
            const wrapper = document.getElementById(wrapperId);

            if (!selectedServiceGroup) {
                renderServiceGroups(wrapper);
            } else {
                renderTodayList(wrapper);
            }
        }

        function renderServiceGroups(container) {
            if (!studentsData || studentsData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No classes found for today</h3>
                        <p>Check the scheduled bookings.</p>
                    </div>`;
                return;
            }

            // Group by Service Title
            const groups = {};
            // Initialize 'All'
            groups['All'] = studentsData;

            studentsData.forEach(s => {
                const title = s.serviceTitle || 'Other';
                if (!groups[title]) {
                    groups[title] = [];
                }
                groups[title].push(s);
            });

            // HTML Generation
            let html = '<div style="background: white; border-top: 1px solid #e5e7eb;">';

            // Helper for row rendering
            const renderGroupRow = (title, count) => {
                const safeTitle = title.replace(/'/g, "\\'");
                return `
                <div onclick="selectServiceGroup('${safeTitle}')" 
                     style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid #E5E7EB; cursor: pointer; transition: background 0.2s;"
                     onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                    
                    <div style="font-size: 16px; font-weight: 500; color: #111827;">
                        ${title}
                    </div>

                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="background: #E5E7EB; color: #374151; padding: 2px 8px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                            ${count}
                        </span>
                        <i class="fas fa-chevron-right" style="color: #9CA3AF; font-size: 14px;"></i>
                    </div>
                </div>
                `;
            };

            // Order: 'All' first, then alphabetical for the rest
            const sortedKeys = Object.keys(groups).filter(k => k !== 'All').sort();

            // Render 'All'
            html += renderGroupRow('All', groups['All'].length);

            // Render others
            sortedKeys.forEach(key => {
                html += renderGroupRow(key, groups[key].length);
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function selectServiceGroup(groupName) {
            selectedServiceGroup = groupName;
            // Clear search when switching groups usually makes sense, OR keep it? 
            // Let's keep it to allow searching across groups effectively if they switch back to All
            // For now, let's just re-render.
            render();
            window.scrollTo(0, 0);
        }

        function clearServiceGroup() {
            selectedServiceGroup = null;
            render();
        }

        function renderTodayList(container) {
            // Filter Data based on selected Group
            let filteredStudents = studentsData;
            if (selectedServiceGroup && selectedServiceGroup !== 'All') {
                filteredStudents = studentsData.filter(s => (s.serviceTitle || 'Other') === selectedServiceGroup);
            }

            // Search Filter (applied on top of group)
            if (todaySearchTerm) {
                const term = todaySearchTerm.toLowerCase();
                filteredStudents = filteredStudents.filter(s => {
                    const name = (s.studentName || '').toLowerCase();
                    const note = (s.note || '').toLowerCase();
                    const project = (s.currentProject || '').toLowerCase();
                    return name.includes(term) || note.includes(term) || project.includes(term);
                });
            }

            // Build UI
            // 1. Header with Back Button and Search
            let headerHtml = `
            <div style="background: white; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 10;">
                <div style="padding: 10px 15px; display: flex; align-items: center; gap: 10px;">
                    <button onclick="clearServiceGroup()" style="background: none; border: none; font-size: 16px; color: #4B5563; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <div style="font-weight: 600; font-size: 16px; color: #111827; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; flex-grow: 1;">
                        ${selectedServiceGroup} (${filteredStudents.length})
                    </div>
                </div>
                <div style="padding: 0 15px 10px 15px;">
                    <input type="text" 
                           id="todaySearchInput"
                           placeholder="Search students..." 
                           value="${todaySearchTerm}"
                           oninput="handleTodaySearch(this.value)"
                           style="width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none;">
                </div>
            </div>
            `;

            // 2. Student List
            if (filteredStudents.length === 0) {
                container.innerHTML = `
                    ${headerHtml}
                    <div class="empty-state">No students found.</div>
                `;
                return;
            }

            let listHtml = '<div style="background: white; padding-bottom: 80px;">';
            filteredStudents.forEach(student => {
                const isCheckedIn = student.checkedIn === true;
                const checkBtnClass = isCheckedIn ? 'check-btn' : 'check-btn unchecked';
                const checkContent = isCheckedIn ? '‚úì' : '';

                const rawName = student.studentName || 'Unknown Student';
                const safeName = rawName.replace(/'/g, "\\'");
                const safeId = (student.studentId || '').toString().replace(/'/g, "\\'");
                const currentProject = student.currentProject || 'No Active Project';

                listHtml += `
                    <div class="student-card" onclick="openStudentDetail('${safeId}', '${safeName}', '${student.headshot || ''}')" style="cursor: pointer;">
                        ${renderHeadshot(student.headshot, rawName, student.studentId)}
                        
                        <div class="student-info">
                            <div class="student-name">${rawName}</div>
                            <div class="student-project">${currentProject}</div>
                            ${student.note ? `
                                <div class="student-note" style="
                                    font-size: 0.85rem; 
                                    color: #d9534f; 
                                    margin-top: 4px; 
                                    font-style: italic; 
                                    font-weight: 500;
                                ">
                                    Note: ${student.note}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="attendance-actions">
                            <!-- Attendance Checkbox -->
                            <button class="${checkBtnClass}" onclick="event.stopPropagation(); toggleAttendance(${student.rowIndex}, ${!isCheckedIn})">
                                 ${checkContent}
                            </button>
                        </div>
                    </div>
                    `;
            });
            listHtml += '</div>';

            container.innerHTML = headerHtml + listHtml;

            // Restore focus if searching
            const input = document.getElementById('todaySearchInput');
            if (input && document.activeElement !== input && todaySearchTerm) {
                // Only restore if we have a term (active search), otherwise it might be annoying on initial load?
                // Actually initial load won't map to this input if we just built it.
                const len = todaySearchTerm.length;
                input.focus();
                if (len > 0) input.setSelectionRange(len, len);
            }

            // Expose Search Handler
            window.handleTodaySearch = (val) => {
                todaySearchTerm = val;
                // We must call render() to trigger the full pipeline or call a sub-function
                // Calling render() is safest to iterate
                render();
            };
        }

        async function toggleAttendance(rowIndex, newStatus) {
            // Optimistic UI Update
            // We proceed immediately. If fetch fails, we revert.
            // This handles cases where navigator.onLine is false but connection exists (localhost, etc)

            // Optimistic UI Update
            const student = studentsData.find(s => s.rowIndex === rowIndex);
            if (student) {
                student.checkedIn = newStatus;
                render(); // Re-render immediately
            }

            try {
                console.log(`Sending attendance update: Row ${rowIndex}, Status ${newStatus}`);
                const response = await fetch('/api/mark-attendance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rowIndex, status: newStatus })
                });

                if (!response.ok) {
                    // Try to parse error from server
                    let errorMsg = 'Server Error';
                    try {
                        const errData = await response.json();
                        errorMsg = errData.error || response.statusText;
                    } catch (parseErr) {
                        errorMsg = response.statusText;
                    }
                    throw new Error(errorMsg);
                }

                // Success
            } catch (e) {
                console.error('Attendance Update Failed:', e);

                // If the browser knows it's offline, or if the error is a network error, show the offline message
                if (!navigator.onLine || e.message === 'Failed to fetch') {
                    alert('You are offline, update was not made.');
                } else {
                    // Otherwise show the specific error (e.g. server error)
                    alert(`Update Failed: ${e.message}`);
                }

                // Revert
                if (student) {
                    student.checkedIn = !newStatus;
                    render();
                }
            }
        }

        async function renderAllStudents(container) {
            container.innerHTML = '<div class="loading-container">Loading all students...</div>';

            let searchTerm = '';

            try {
                const response = await fetch('/api/all-kids');
                const data = await response.json();

                if (!data.success) throw new Error(data.error);

                const students = data.kids;

                const renderList = () => {
                    const filtered = students.filter(s =>
                        s.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (s.email && s.email.toLowerCase().includes(searchTerm.toLowerCase()))
                    );

                    if (filtered.length === 0) {
                        return `<div class="empty-state">No students found matching "${searchTerm}"</div>`;
                    }

                    return filtered.map(s => {
                        const safeName = s.name.replace(/'/g, "\\'");
                        const safeId = (s.id || '').toString().replace(/'/g, "\\'");

                        return `
                        <div class="student-card" onclick="openStudentDetail('${safeId}', '${safeName}', '${s.headshot || ''}')" style="cursor: pointer;">
                            ${renderHeadshot(s.headshot, s.name, s.id)}
                            <div class="student-info">
                                <div class="student-name">${s.name}</div>
                                <div class="student-project" style="color: #6B7280;">${s.email || 'No email'}</div>
                            </div>
                            <div class="attendance-actions">
                                <button onclick="event.stopPropagation(); openStudentEditModal('${safeId}')" style="background:none; border:none; font-size: 20px; cursor: pointer; padding: 10px;">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="event.stopPropagation(); openNoteModal('${safeId}')" style="background:none; border:none; font-size: 20px; cursor: pointer; padding: 10px;">
                                    ‚ÑπÔ∏è
                                </button>
                            </div>
                        </div>
                        `;
                    }).join('');
                };

                const updateView = () => {
                    const searchBar = `
                        <div style="background: white; padding: 10px 15px; border-bottom: 1px solid #E5E7EB; position: sticky; top: 0; z-index: 10;">
                            <input type="text" id="studentSearch" placeholder="Search students..." 
                                value="${searchTerm}"
                                oninput="this.focus()"
                                style="width: 100%; padding: 10px 15px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 16px; outline: none;">
                        </div>
                    `;
                    container.innerHTML = searchBar + '<div id="allStudentsList" style="background: white;">' + renderList() + '</div>';

                    // Attach Logic
                    const input = document.getElementById('studentSearch');
                    input.addEventListener('input', (e) => {
                        searchTerm = e.target.value;
                        const list = document.getElementById('allStudentsList');
                        if (list) list.innerHTML = renderList();
                    });
                    // Restore focus (simple hack: value is set in HTML but input replaces DOM. actually we replace innerHTML so focus lost. 
                    // Better: Only replace list part. logic above handles that by `list.innerHTML = renderList()`)
                };

                updateView();

            } catch (e) {
                container.innerHTML = `<div class="empty-state"><h3>Failed to load students</h3><p>${e.message}</p></div>`;
            }
        }

        // ============================================================================
        // NOTE MODAL
        // ============================================================================
        window.openNoteModal = async function (studentId) {
            // Remove existing modal if any
            const existing = document.getElementById('noteModal');
            if (existing) existing.remove();

            // Find current data for this student
            let currentNote = '';
            try {
                // We could fetch from API, or use loaded data if we had it stored globally better. 
                // Since `renderAllStudents` fetches fresh data locally, we don't have global access easily unless we change scoping.
                // Safest is to fetch fresh details or re-fetch 'all-kids' logic is heavy.
                // Let's rely on checking if we can get it from the DOM or fetch it.
                // Actually, fetching student detail is best practice to ensure fresh data.

                // Show LOADING state
                const modal = document.createElement('div');
                modal.id = 'noteModal';
                modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:4000; display:flex; justify-content:center; align-items:center;';

                modal.innerHTML = `
                    <div style="background:white; width:90%; max-width:500px; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                        <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:#f8f9fa;">
                            <h3 style="margin:0; color:#333;">Student Note</h3>
                            <button onclick="document.getElementById('noteModal').remove()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
                        </div>
                        <div style="padding:20px;">
                            <textarea id="studentNoteText" style="width:100%; height:150px; padding:10px; border:1px solid #ddd; border-radius:8px; font-family:inherit; resize:vertical;" placeholder="Enter note here...">Loading...</textarea>
                        </div>
                         <div style="padding:15px; border-top:1px solid #eee; background:#f8f9fa; text-align:right;">
                            <button onclick="document.getElementById('noteModal').remove()" style="padding:8px 16px; border:1px solid #ccc; background:white; border-radius:6px; margin-right:10px; cursor:pointer;">Cancel</button>
                            <button id="saveNoteBtn" onclick="saveNote('${studentId}')" style="padding:8px 20px; border:none; background:#2563EB; color:white; border-radius:6px; font-weight:bold; cursor:pointer;" disabled>Save Data</button>
                        </div>
                    </div>
                 `;
                document.body.appendChild(modal);

                // Now Fetch Data to pre-fill
                // We can use the student-detail endpoint or all-kids.
                // all-kids is cleaner field-wise.
                const res = await fetch('/api/all-kids');
                const data = await res.json();

                if (data.success) {
                    const s = data.kids.find(k => k.id === studentId);
                    if (s) {
                        currentNote = s.note || '';
                        const txt = document.getElementById('studentNoteText');
                        if (txt) {
                            txt.value = currentNote;
                            document.getElementById('saveNoteBtn').disabled = false;
                        }
                    }
                }

            } catch (e) {
                console.error("Error loading note:", e);
                alert("Could not load note.");
                document.getElementById('noteModal').remove();
            }
        };

        window.saveNote = async function (studentId) {
            const txt = document.getElementById('studentNoteText');
            const btn = document.getElementById('saveNoteBtn');
            if (!txt || !btn) return;

            const noteContent = txt.value;
            btn.disabled = true;
            btn.innerText = 'Saving...';

            try {
                const res = await fetch('/api/update-student-note', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentId: studentId,
                        note: noteContent
                    })
                });

                const data = await res.json();
                if (!data.success) throw new Error(data.error);

                alert('Note saved successfully!');
                document.getElementById('noteModal').remove();

                // Refresh list
                const listContainer = document.getElementById('allStudentsList');
                if (listContainer) {
                    if (typeof switchTab === 'function') {
                        switchTab('all-students'); // properly re-fetch
                    }
                }

            } catch (e) {
                alert('Save Failed: ' + e.message);
                btn.disabled = false;
                btn.innerText = 'Save Data';
            }
        };

        // ============================================================================
        // EDIT STUDENT MODAL
        // ============================================================================
        window.openStudentEditModal = async function (studentId) {
            // Remove existing modal if any
            const existing = document.getElementById('editStudentModal');
            if (existing) existing.remove();

            // Create Modal Structure
            const modal = document.createElement('div');
            modal.id = 'editStudentModal';
            modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:4000; display:flex; justify-content:center; align-items:center;';

            modal.innerHTML = `
                <div style="background:white; width:90%; max-width:600px; max-height:90vh; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                    <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:#f8f9fa;">
                        <h3 style="margin:0; color:#333;">Edit Student Details</h3>
                        <button onclick="document.getElementById('editStudentModal').remove()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
                    </div>
                    <div id="editStudentFormContent" style="padding:20px; overflow-y:auto; flex-grow:1;">
                        <div style="text-align:center; padding:20px; color:#666;">Loading details...</div>
                    </div>
                    <div style="padding:15px; border-top:1px solid #eee; background:#f8f9fa; text-align:right;">
                        <button onclick="document.getElementById('editStudentModal').remove()" style="padding:8px 16px; border:1px solid #ccc; background:white; border-radius:6px; margin-right:10px; cursor:pointer;">Cancel</button>
                        <button id="saveStudentBtn" onclick="submitStudentEdit('${studentId}')" style="padding:8px 20px; border:none; background:#db3236; color:white; border-radius:6px; font-weight:bold; cursor:pointer;" disabled>Save Changes</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            try {
                const res = await fetch('/api/student-detail/' + encodeURIComponent(studentId));
                const data = await res.json();

                if (!data.success) throw new Error(data.error);

                const { headers, row } = data;

                let formHtml = '<div style="display:grid; grid-template-columns: 1fr; gap:15px;">';

                // Column Permissions Configuration
                const readOnlyIndices = [0, 1, 2, 3, 4, 33]; // A, B, C, D, E, AH

                // Fields to HIDE
                // F(5), H(7), I(8), J(9), K(10)
                // Range N(13)-AD(29) was hiding everything, but we need N(13) and AC(28).
                // So let's hide O(14) - AD(29) generally, plus the specific ones.
                const hiddenIndices = [5, 7, 8, 9, 10];
                for (let i = 14; i <= 29; i++) hiddenIndices.push(i);
                hiddenIndices.push(31, 32); // AF, AG

                // EXCEPTION: Show Column AC (Index 28) which is inside our hidden range [14-29]
                const showIndices = [28];

                headers.forEach((header, index) => {
                    const value = row[index] || '';
                    const safeValue = value.replace(/"/g, '&quot;');

                    // Hidden fields logic
                    if (hiddenIndices.includes(index) && !showIndices.includes(index)) {
                        formHtml += `<input type="hidden" class="edit-student-input" data-index="${index}" value="${safeValue}">`;
                        return;
                    }

                    const isReadOnly = readOnlyIndices.includes(index);
                    const readOnlyAttr = isReadOnly ? 'readonly disabled style="background:#f0f0f0; color:#888; cursor: not-allowed;"' : '';

                    // === CUSTOM RENDERERS ===

                    // 1. ACTIVE? (Index 12 / M)
                    if (index === 12) {
                        const activeOptions = ["active", "paused"];
                        const optionsHtml = activeOptions.map(opt =>
                            `<option value="${opt}" ${opt.toLowerCase() === value.toLowerCase() ? 'selected' : ''}>${opt}</option>`
                        ).join('');

                        formHtml += `
                        <div>
                            <label style="display:block; font-weight:600; font-size:12px; color:#555; margin-bottom:4px;">${header}</label>
                            <select class="edit-student-input" data-index="${index}" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; background:white;">
                                <option value="">-- Select Status --</option>
                                ${optionsHtml}
                                ${!activeOptions.includes(value.toLowerCase()) && value ? `<option value="${safeValue}" selected>${value} (Custom)</option>` : ''}
                            </select>
                        </div>`;
                        return;
                    }

                    // 2. PREFERENCE (Index 13 / N)
                    if (index === 13) {
                        const prefOptions = ["Building", "Coding", "Both", "Doesn't know"];
                        const optionsHtml = prefOptions.map(opt =>
                            `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`
                        ).join('');

                        formHtml += `
                        <div>
                            <label style="display:block; font-weight:600; font-size:12px; color:#555; margin-bottom:4px;">${header}</label>
                            <select class="edit-student-input" data-index="${index}" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; background:white;">
                                <option value="">-- Select Preference --</option>
                                ${optionsHtml}
                                ${!prefOptions.includes(value) && value ? `<option value="${safeValue}" selected>${value} (Custom)</option>` : ''}
                            </select>
                        </div>`;
                        return;
                    }

                    // 3. TRACK (Index 28 / AC)
                    if (index === 28) {
                        const trackOptions = [
                            "TRACK_GAME_DEV_SCRATCH",
                            "TRACK_INTRO_TO_AI",
                            "TRACK_PYTHON_ADVANCED",
                            "TRACK_PYTHON_BASICS",
                            "TRACK_SCRATCH_ADVANCED",
                            "TRACK_SCRATCH_BASICS",
                            "TRACK-PYBASICS", "TRACK-PYBOT", "TRACK-GAMES", "TRACK-STARTING",
                            "TRACK-PYGAMES", "TRACK-BUILDING", "TRACK-TEST",
                            "HALF-5-SCR-BASICS-Y", "HALF-5-SCR-O", "HALF-5-PYTH-O",
                            "ALL-5-SCR-O", "ALL-5-PYTH-O", "ALL-3-PYTH-O",
                            "HALF-3-SCR-O", "HALF-3-SCR-Y", "ALL-5-SCR-Y",
                            "TRIAL-YOUNGER", "TRIAL-PYTHON-O"
                        ];

                        const optionsHtml = trackOptions.map(opt =>
                            `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`
                        ).join('');

                        formHtml += `
                        <div>
                            <label style="display:block; font-weight:600; font-size:12px; color:#555; margin-bottom:4px;">${header} (System Track)</label>
                            <select 
                                class="edit-student-input" 
                                data-index="${index}"
                                style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; background:white;">
                                <option value="">-- Select Track --</option>
                                ${optionsHtml}
                                <!-- Allow retaining value if it's not in the list -->
                                ${!trackOptions.includes(value) && value ? `<option value="${safeValue}" selected>${value} (Custom)</option>` : ''}
                            </select>
                        </div>
                        `;
                        return;
                    }

                    formHtml += `
                        <div>
                            <label style="display:block; font-weight:600; font-size:12px; color:#555; margin-bottom:4px;">${header}</label>
                            <input type="text" 
                                class="edit-student-input" 
                                data-index="${index}" 
                                value="${safeValue}" 
                                ${readOnlyAttr}
                                style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; ${isReadOnly ? 'background:#f0f0f0; color:#666;' : ''}">
                        </div>
                    `;
                });

                formHtml += '</div>';

                const container = document.getElementById('editStudentFormContent');
                if (container) {
                    container.innerHTML = formHtml;
                    document.getElementById('saveStudentBtn').disabled = false;
                }

            } catch (err) {
                const container = document.getElementById('editStudentFormContent');
                if (container) container.innerHTML = `<div style="color:red; text-align:center;">Error: ${err.message}</div>`;
            }
        };

        window.submitStudentEdit = async function (studentId) {
            const btn = document.getElementById('saveStudentBtn');
            btn.disabled = true;
            btn.innerText = 'Saving...';

            try {
                // Gather all inputs
                const inputs = document.querySelectorAll('.edit-student-input');
                const values = [];
                // Initialize array with explicit size if needed, but pushing in order is fine 
                // as long as we iterate by DOM order which should match create order.
                // However, let's use data-index to be safe.

                // Find max index to size array
                let maxIndex = 0;
                inputs.forEach(inp => {
                    const idx = parseInt(inp.dataset.index);
                    if (idx > maxIndex) maxIndex = idx;
                });

                // Fill values
                for (let i = 0; i <= maxIndex; i++) {
                    values.push(''); // Fill empty
                }

                inputs.forEach(inp => {
                    const idx = parseInt(inp.dataset.index);
                    values[idx] = inp.value;
                });

                const res = await fetch('/api/student-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentId: studentId,
                        values: values,
                        userEmail: localStorage.getItem('instructorName') || 'Instructor'
                    })
                });

                const data = await res.json();
                if (!data.success) throw new Error(data.error);

                alert('Student details updated successfully!');
                document.getElementById('editStudentModal').remove();

                // Refresh list if we are on All Kids page
                // We don't have direct access to 'renderAllStudents' container easily unless we store it globally 
                // or just trigger click on tab again.
                // Re-clicking the tab is easiest way to refresh.
                const allKidsTab = document.querySelector('button[onclick*="renderAllStudents"]');
                // Actually the tabs are handled by openTab usually.
                // Let's just try to refresh the active view if it ID matches
                const listContainer = document.getElementById('allStudentsList');
                if (listContainer) {
                    // Trigger a simpler refresh or reload page?
                    // Reloading data is cleaner.
                    // Finding the tab button:
                    // The tabs in index.html are separate. 
                    // In instructor-dashboard, tabs are:
                    // <div class="nav-item" onclick="switchTab('today')">TODAY</div>
                    // <div class="nav-item" onclick="switchTab('all-students')">ALL STUDENTS</div>

                    // Calling switchTab('all-students') works if defined globally.
                    if (typeof switchTab === 'function') {
                        switchTab('all-students');
                    } else {
                        location.reload();
                    }
                }

            } catch (err) {
                alert('Saved Failed: ' + err.message);
                btn.disabled = false;
                btn.innerText = 'Save Changes';
            }
        };


        // ============================================================================
        // LEADERBOARD RENDERER
        // ============================================================================
        let leaderboardScope = 'all'; // all, monthly, weekly

        // Helper to format name from email if needed
        const formatName = (str) => {
            if (!str) return 'Unknown';
            // If it looks like an email, take the part before @
            if (str.includes('@')) {
                const parts = str.split('@');
                const namePart = parts[0];
                // Capitalize first letter
                return namePart.charAt(0).toUpperCase() + namePart.slice(1);
            }
            return str;
        };

        async function renderLeaderboard(container) {
            container.innerHTML = '<div class="loading-container">Loading Rankings...</div>';

            try {
                const response = await fetch('/api/leaderboard');
                const data = await response.json();

                if (!data.success) throw new Error(data.error);

                const stats = data.leaderboard;

                // Sort function
                const sortData = (scope) => {
                    return [...stats].sort((a, b) => {
                        const valA = scope === 'weekly' ? a.weeklyPoints : (scope === 'monthly' ? a.monthlyPoints : a.totalPoints);
                        const valB = scope === 'weekly' ? b.weeklyPoints : (scope === 'monthly' ? b.monthlyPoints : b.totalPoints);
                        return valB - valA; // Descending
                    }).filter(s => {
                        // Filter out zero points for weekly/monthly views to keep list clean? 
                        // Or show everyone? User said "Leaderboard". Usually implies top scorers.
                        // Let's show everyone who has > 0 points in that category.
                        const val = scope === 'weekly' ? s.weeklyPoints : (scope === 'monthly' ? s.monthlyPoints : s.totalPoints);
                        return val > 0;
                    });
                };

                const renderList = () => {
                    const sorted = sortData(leaderboardScope);

                    if (sorted.length === 0) {
                        return '<div class="empty-state">No points recorded for this period yet!</div>';
                    }

                    return sorted.map((s, idx) => {
                        const rank = idx + 1;
                        let rankIcon = `<span style="font-weight:bold; color:#666; width:24px; display:inline-block; text-align:center;">${rank}</span>`;
                        if (rank === 1) rankIcon = 'ü•á';
                        if (rank === 2) rankIcon = 'ü•à';
                        if (rank === 3) rankIcon = 'ü•â';

                        const score = leaderboardScope === 'weekly' ? s.weeklyPoints : (leaderboardScope === 'monthly' ? s.monthlyPoints : s.totalPoints);

                        // Safe ID for headshot
                        const safeId = s.id ? s.id.toString().replace(/\//g, '_') : '';
                        const headshotSrc = safeId ? `/headshots/${safeId}.jpg` : s.headshot;

                        return `
                       <div style="display:flex; align-items:center; background:white; padding:15px; border-bottom:1px solid #eee; min-height:72px;">
                           <div style="font-size:24px; margin-right:15px; width:40px; text-align:center;">${rankIcon}</div>
                           
                           <div style="position: relative; width: 44px; height: 44px; margin-right: 15px;">
                                <img src="${headshotSrc || '/api/placeholder/44/44'}" 
                                     style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 1px solid #eee;"
                                     onerror="this.onerror=null; this.src='${s.headshot || '/api/placeholder/44/44'}';">
                           </div>

                           <div style="flex-grow:1;">
                               <div style="font-weight:600; color:#333; font-size:16px;">${formatName(s.name)}</div>
                           </div>
                           
                           <div style="font-weight:bold; font-size:18px; color:#db3236;">
                                ${score} <span style="font-size:10px; color:#666; text-transform:uppercase;">pts</span>
                           </div>
                       </div>
                       `;
                    }).join('');
                };

                // Header with Toggles
                const headerHtml = `
                    <div style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: center; gap: 10px; position: sticky; top: 0; z-index: 10;">
                        <button onclick="changeLeaderboardScope('all')" 
                            style="padding: 8px 16px; border-radius: 20px; border: 1px solid ${leaderboardScope === 'all' ? '#db3236' : '#ccc'}; background: ${leaderboardScope === 'all' ? '#db3236' : 'white'}; color: ${leaderboardScope === 'all' ? 'white' : '#666'}; font-weight: 500;">
                            All Time
                        </button>
                        <button onclick="changeLeaderboardScope('monthly')" 
                            style="padding: 8px 16px; border-radius: 20px; border: 1px solid ${leaderboardScope === 'monthly' ? '#db3236' : '#ccc'}; background: ${leaderboardScope === 'monthly' ? '#db3236' : 'white'}; color: ${leaderboardScope === 'monthly' ? 'white' : '#666'}; font-weight: 500;">
                            This Month
                        </button>
                        <button onclick="changeLeaderboardScope('weekly')" 
                            style="padding: 8px 16px; border-radius: 20px; border: 1px solid ${leaderboardScope === 'weekly' ? '#db3236' : '#ccc'}; background: ${leaderboardScope === 'weekly' ? '#db3236' : 'white'}; color: ${leaderboardScope === 'weekly' ? 'white' : '#666'}; font-weight: 500;">
                            This Week
                        </button>
                    </div>
                `;

                container.innerHTML = headerHtml + '<div>' + renderList() + '</div>';

                // Expose scope changer globally
                window.changeLeaderboardScope = (scope) => {
                    leaderboardScope = scope;
                    renderLeaderboard(container);
                };

            } catch (err) {
                container.innerHTML = `<div class="empty-state"><h3>Error loading leaderboard</h3><p>${err.message}</p></div>`;
            }
        }





        // ============================================================================
        // STUDENT DETAIL VIEW
        // ============================================================================

        // [Removed duplicate openStudentDetail/renderStudentDetail implementation]

        // Helper specifically for Completed section (no action button)
        function renderSection(title, items, icon, colorClass) {
            if (!items || items.length === 0) return '';

            const getIcon = (type) => { // Duplicate helper but safely scoped
                const lower = (type || '').toLowerCase();
                if (lower.includes('scratch')) return 'üê±';
                if (lower.includes('python')) return 'üêç';
                if (lower.includes('web')) return 'üåê';
                return 'üìÑ';
            };

            let listHtml = items.map(p => `
                <div style="background: white; padding: 12px; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                    <div style="font-size: 24px; margin-right: 15px;">${getIcon(p.type)}</div>
                    <div style="flex-grow: 1;">
                        <div style="font-weight: 600; color: #333; font-size: 15px;">${p.name}</div>
                        <div style="font-size: 12px; color: #777; margin-top: 2px;">
                            ${p.type || 'Project'} ‚Ä¢ ${p.date || p.completedDate || p.status || 'Assigned'}
                        </div>
                    </div>
                    ${p.rating ? `<div style="font-weight:bold; color:#F59E0B;">${p.rating}‚òÖ</div>` : ''}
                </div>
            `).join('');

            return `
                <div style="margin-top: 20px; background: white; border-top: 4px solid ${colorClass}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; align-items: center; font-weight: bold; color: #444;">
                        <span style="margin-right: 10px;">${icon}</span> ${title} (${items.length})
                    </div>
                    <div>${listHtml}</div>
                </div>
            `;
        }

        function renderSectionWithAction(title, items, icon, colorClass, studentId, studentName, headshotUrl) {
            if (!items || items.length === 0) return '';

            const getIcon = (type) => {
                const lower = (type || '').toLowerCase();
                if (lower.includes('scratch')) return 'üê±';
                if (lower.includes('python')) return 'üêç';
                if (lower.includes('web')) return 'üåê';
                return 'üìÑ';
            };

            // Helper to escape for HTML attribute (double quotes)
            const safeAttr = (str) => (str || '').toString().replace(/"/g, '&quot;');

            let listHtml = items.map(p => `
                <div class="project-item-row"
                     data-sid="${safeAttr(studentId)}"
                     data-pcode="${safeAttr(p.originalCode)}"
                     data-pname="${safeAttr(p.name)}"
                     data-headshot="${safeAttr(headshotUrl)}"
                     data-sname="${safeAttr(studentName)}"
                     data-video="${safeAttr(p.videoLink)}"
                     data-rating="${safeAttr(p.rating)}"
                     style="background: white; padding: 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; position: relative; cursor: pointer; transition: background 0.2s;">
                    <div style="font-size: 24px; margin-right: 15px;">${getIcon(p.type)}</div>
                    <div style="flex-grow: 1; padding-right: 40px;">
                        <div style="font-weight: 600; color: #333; font-size: 15px;">${p.name}</div>
                        <div style="font-size: 12px; color: #777; margin-top: 2px;">
                            ${p.type || 'Project'} ‚Ä¢ ${p.date || 'Assigned'}
                        </div>
                    </div>
                    <div style="position: absolute; right: 60px; bottom: 10px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10;" title="Delete Project">
                        <button class="delete-btn" data-uniqueid="${p.uniqueId || ''}" style="background: none; border: none; color: #ef4444; font-size: 18px; cursor: pointer; padding: 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div style="position: absolute; right: 10px; bottom: 10px; background: #ECFDF5; color: #047857; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); cursor: pointer; border: 1px solid #6EE7B7; z-index: 10;">
                        <span style="font-size: 20px; pointer-events: none;">${p.videoLink ? 'üé•' : '‚úì'}</span>
                    </div>
                </div>
            `).join('');

            return `
                <div style="margin-top: 20px; background: white; border-top: 4px solid ${colorClass}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; align-items: center; font-weight: bold; color: #444;">
                        <span style="margin-right: 10px;">${icon}</span> ${title} (${items.length})
                    </div>
                    <div>${listHtml}</div>
                </div>
            `;
        }

        // Global Event Delegation for robustness
        // Handles clicks on dynamic elements without needing inline onclicks
        document.addEventListener('click', function (e) {
            // 1. Delete Project Click (High Priority)
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                e.preventDefault();
                e.stopPropagation();

                const uniqueId = deleteBtn.dataset.uniqueid;

                if (!uniqueId) {
                    alert('Error: Cannot delete this project (Missing ID)');
                    return;
                }

                if (confirm('Are you sure you want to delete this project assignment? This cannot be undone.')) {
                    // Show loading on the button itself or global
                    deleteBtn.innerHTML = '...';

                    fetch('/api/delete-project-log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            uniqueId: uniqueId,
                            instructorName: localStorage.getItem('instructorName') || 'Unknown'
                        })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                // Find parent row to get Student ID for refresh
                                const row = deleteBtn.closest('.project-item-row');
                                if (row) {
                                    openStudentDetail(row.dataset.sid, row.dataset.sname, row.dataset.headshot);
                                } else {
                                    alert('Deleted! Please refresh.');
                                }
                            } else {
                                alert('Delete failed: ' + data.error);
                                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            alert('Delete failed: Server Error');
                            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        });
                }
                return; // Stop further listeners (like the row click)
            }

            // 2. Student Card Click (Dashboard)
            const card = e.target.closest('.student-card');
            if (card) {
                // Ignore if clicked on button/action inside
                if (e.target.closest('button') || e.target.closest('.check-btn')) return;

                const d = card.dataset;
                if (d.sid) {
                    openStudentDetail(d.sid, d.sname, d.headshot);
                    return;
                }
            }

            // 3. Project Item Click (Detail View)
            const row = e.target.closest('.project-item-row');
            if (row) {
                e.stopPropagation(); // Stop bubbling
                console.log('Row Click Detected:', row.dataset);
                try {
                    const d = row.dataset;
                    // Ensure modal function exists
                    if (window.openCompletionModal) {
                        window.openCompletionModal(d.sid, d.pcode, d.pname, d.headshot, d.sname, d.video, d.rating, d.status, d.date);
                    } else {
                        console.error('Modal function not found!');
                        alert('System Error: Modal function missing. Please refresh.');
                    }
                } catch (e) {
                    console.error('Row click error:', e);
                }
            }
        });

        window.openCompletionModal = function (studentId, projectCode, projectName, headshotUrl, studentName, existingVideo, existingRating, currentStatus, successfulDate) {
            // Helper for inline onclick strings
            const safeStr = (str) => (str || '').toString().replace(/'/g, "\\'").replace(/\n/g, ' ').replace(/\r/g, '');

            const modalId = 'completionModal';
            const existing = document.getElementById(modalId);
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 3005; overflow-y: auto; padding-bottom: 50px;';

            // Convert Drive link to Preview link for iframe
            let embedUrl = '';
            if (existingVideo && existingVideo.includes('drive.google.com')) {
                embedUrl = existingVideo.replace('/view', '/preview');
            }

            const isViewMode = !!(existingVideo && existingRating);
            const initialRating = existingRating ? parseInt(existingRating) : 0;

            modal.innerHTML = `
                <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                    <div style="display: flex; align-items: center; margin-bottom: 30px;">
                        <button onclick="document.getElementById('${modalId}').remove()" style="background: none; border: none; font-size: 24px; padding: 0; margin-right: 15px;">‚úï</button>
                        <h2 style="margin: 0; font-size: 18px;">${isViewMode ? 'Project Evidence' : 'Complete Project'}</h2>
                    </div>
                    <div style="text-align: center; margin-bottom: 30px;">
                         <img src="${studentId ? `/headshots/${studentId.toString().replace(/\//g, '_')}.jpg` : headshotUrl}"
                              onerror="this.onerror=null; this.src='${headshotUrl || '/api/placeholder/80/80'}';" 
                              style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; margin-bottom: 10px;">
                         <h3 style="margin: 0; color: #333;">${studentName}</h3>
                         <div style="color: #666; margin-top: 5px; font-weight: 500;">${projectName}</div>
                    </div>

                    <!-- VIEW MODE -->
                    <div id="viewMode" style="display: ${isViewMode ? 'block' : 'none'};">
                        <div style="margin-bottom: 30px; text-align: center;">
                            <div style="margin-bottom: 10px; font-weight: 600; color: #444;">Rated by Student</div>
                            <div class="star-rating-static" style="font-size: 40px; color: #ddd;">
                                ${[1, 2, 3, 4, 5].map(i => `<span style="color: ${i <= initialRating ? '#F59E0B' : '#ddd'};">‚òÖ</span>`).join('')}
                            </div>
                        </div>
                        
                        ${embedUrl ? `
                        <div style="margin-bottom: 30px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <iframe src="${embedUrl}" width="100%" height="320" style="border:none;"></iframe>
                        </div>
                        ` : ''}

                        <button onclick="switchToEditMode()" 
                             style="width: 100%; border: 2px solid #db3236; color: #db3236; background: white; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
                            üîÑ Update / Redo
                        </button>
                    </div>

                    <!-- EDIT MODE (For new or updating) -->
                    <div id="editMode" style="display: ${isViewMode ? 'none' : 'block'};">
                        <div style="margin-bottom: 40px; text-align: center;">
                            <div style="margin-bottom: 10px; font-weight: 600; color: #444;">Ask ${studentName} how they would rate this project?</div>
                            <div class="star-rating" style="font-size: 40px; color: #ddd; cursor: pointer;">
                                <span onclick="setRating(1)" data-val="1">‚òÖ</span>
                                <span onclick="setRating(2)" data-val="2">‚òÖ</span>
                                <span onclick="setRating(3)" data-val="3">‚òÖ</span>
                                <span onclick="setRating(4)" data-val="4">‚òÖ</span>
                                <span onclick="setRating(5)" data-val="5">‚òÖ</span>
                            </div>
                            <input type="hidden" id="selectedRating" value="${initialRating}">
                        </div>

                         ${embedUrl ? `
                        <div style="margin-bottom: 20px; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); background: #f0f0f0;">
                            <div style="padding: 8px; font-size: 12px; color: #666; text-align: center; border-bottom: 1px solid #ddd;">Current Video</div>
                            <iframe src="${embedUrl}" width="100%" height="240" style="border:none;"></iframe>
                        </div>
                        ` : ''}

                        <div style="border: 2px dashed #CBD5E0; border-radius: 12px; padding: 30px; text-align: center; margin-bottom: 20px; background: #F7FAFC;">
                            <input type="file" id="modalVideoInput" accept="video/*" style="display: none;" onchange="handleModalFileSelect(this)">
                            <div style="display: flex; gap: 15px; justify-content: center;">
                                <label for="modalVideoInput" style="cursor: pointer; flex: 1; border: 1px solid #CBD5E0; border-radius: 8px; padding: 15px; background: white;">
                                    <div style="font-size: 30px; margin-bottom: 5px;">üìÅ</div>
                                    <span style="color: #4A5568; font-weight: 500; display: block;">Upload File</span>
                                </label>
                                
                                <div onclick="openCamera()" style="cursor: pointer; flex: 1; border: 1px solid #CBD5E0; border-radius: 8px; padding: 15px; background: white;">
                                    <div style="font-size: 30px; margin-bottom: 5px;">üé•</div>
                                    <span style="color: #4A5568; font-weight: 500; display: block;">Record (720p)</span>
                                </div>
                            </div>
                            <div id="modalFileName" style="margin-top: 10px; color: #3182CE; font-size: 0.9em; font-weight: bold; overflow-wrap: break-word;"></div>
                        </div>

                        <!-- CAMERA OVERLAY -->
                        <div id="cameraOverlay" style="display: none; position: fixed; top: 0; left: 0; w: 100%; h: 100%; background: black; z-index: 2000; flex-direction: column; align-items: center; justify-content: center;">
                             <video id="cameraPreview" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover;"></video>
                             <div style="position: absolute; bottom: 30px; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%;">
                                 <div id="recordingTimer" style="color: white; font-size: 20px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 4px; display: none;">00:00</div>
                                 <div style="display: flex; gap: 30px; align-items: center;">
                                     <button onclick="closeCamera()" style="background: white; color: black; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold;">Cancel</button>
                                     <button id="recordBtn" onclick="toggleRecording()" style="width: 70px; height: 70px; border-radius: 50%; background: #ff3b30; border: 4px solid white; cursor: pointer;"></button>
                                 </div>
                             </div>
                        </div>

                        <div id="modalProgressContainer" style="display: none; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; color: #4A5568; font-size: 0.9em;">
                                <span id="modalUploadStatus">Uploading...</span>
                                <span id="modalUploadPercent">0%</span>
                            </div>
                            <div style="width: 100%; height: 10px; background: #EDF2F7; border-radius: 5px; overflow: hidden;">
                                <div id="modalProgressBar" style="width: 0%; height: 100%; background: #48BB78; transition: width 0.3s ease;"></div>
                            </div>
                        </div>

                        <div style="margin-top: 20px; text-align: left; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 5px;">Project Status</label>
                                <select id="modalStatusSelect" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #cbd5e0; background: white; font-size: 16px;">
                                    <option value="Completed" ${(!currentStatus || currentStatus === 'Completed') ? 'selected' : ''}>Completed</option>
                                    <option value="In Progress" ${(currentStatus === 'In Progress') ? 'selected' : ''}>Working On</option>
                                    <option value="Assigned" ${(currentStatus === 'Assigned') ? 'selected' : ''}>Assigned (Not Started)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 5px;">Completion Date</label>
                                <input type="date" id="modalDatePicker" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #cbd5e0; font-size: 16px;">
                            </div>
                        </div>

                        <button id="completeBtn" onclick="submitCompletion('${studentId}', '${projectCode}', '${studentName.replace(/'/g, "\\'")}', '${headshotUrl}', '${safeStr(existingVideo)}')" 
                            style="width: 100%; background: #db3236; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; opacity: 0.5; cursor: not-allowed; margin-top: 20px;" disabled>
                            ${isViewMode ? 'Update Project' : 'UPLOAD & Mark Complete'}
                        </button>
                    </div>

                    <div id="completionResult" style="text-align: center; margin-top: 15px; display: none;"></div>
                </div>
            `;

            document.body.appendChild(modal);

            // Set default date
            setTimeout(() => {
                const dateInput = document.getElementById('modalDatePicker');
                if (dateInput) {
                    let d = new Date();
                    if (successfulDate) {
                        d = new Date(successfulDate);
                    }
                    // Format YYYY-MM-DD
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    dateInput.value = `${year}-${month}-${day}`;
                }
            }, 100);

            // Logic to switch modes
            window.switchToEditMode = () => {
                document.getElementById('viewMode').style.display = 'none';
                document.getElementById('editMode').style.display = 'block';
                // Pre-fill rating stars if existing
                if (initialRating > 0) {
                    window.setRating(initialRating);
                }
            };

            window.setRating = (val) => {
                document.getElementById('selectedRating').value = val;
                const stars = document.querySelectorAll('.star-rating span');
                stars.forEach((s, idx) => {
                    s.style.color = (idx < val) ? '#F59E0B' : '#ddd';
                });
                checkSubmitReady();
            };

            window.handleModalFileSelect = (input) => {
                if (input.files && input.files[0]) {
                    document.getElementById('modalFileName').innerText = input.files[0].name;
                    checkSubmitReady();
                }
            };

            window.checkSubmitReady = () => {
                const rating = document.getElementById('selectedRating').value;
                const file = document.getElementById('modalVideoInput').files[0];
                const btn = document.getElementById('completeBtn');
                const hasExistingVideo = document.querySelector('#videoSection iframe') !== null; // Rough check, but we pass existingVideo to submit anyway

                // In edit mode, we need: Rating > 0 AND (File selected OR Existing Video present)
                if (rating > 0 && (file || existingVideo)) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                } else {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                }
            };

            window.submitCompletion = async (sid, pCode, sName, sHeadshot, existingLink) => {
                const btn = document.getElementById('completeBtn');
                const resultDiv = document.getElementById('completionResult');
                const file = document.getElementById('modalVideoInput').files[0];
                const rating = document.getElementById('selectedRating').value;

                // Check if we have an auto-uploaded link from Camera
                const preUploadedLink = document.getElementById('hiddenUploadedLink') ? document.getElementById('hiddenUploadedLink').value : null;

                const statusStr = document.getElementById('modalStatusSelect').value;
                const dateStr = document.getElementById('modalDatePicker').value;

                btn.disabled = true;
                btn.innerText = (file && !preUploadedLink) ? 'Uploading video...' : 'Updating...';

                try {
                    let videoLink = existingLink; // Default to existing

                    // Priority 1: Pre-uploaded Link (Camera)
                    if (preUploadedLink) {
                        videoLink = preUploadedLink;
                    }
                    // Priority 2: File Input (Manual Upload)
                    else if (file) {
                        videoLink = await uploadVideoFile(file);
                        btn.innerText = 'Saving...';
                    }

                    const response = await fetch('/api/complete-project', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            studentId: sid,
                            projectCode: pCode,
                            videoLink: videoLink,
                            rating: rating,
                            instructorName: localStorage.getItem('instructorName') || 'Unknown',
                            status: statusStr,
                            date: dateStr
                        })
                    });

                    const data = await response.json();
                    if (!data.success) throw new Error(data.error);

                    btn.innerText = 'Success!';
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = '<span style="color: green; font-weight: bold;">‚úÖ Project Updated!</span>';

                    setTimeout(() => {
                        document.getElementById('completionModal').remove();
                        openStudentDetail(sid, sName, sHeadshot);
                    }, 1500);

                } catch (e) {
                    console.error(e);
                    btn.disabled = false;
                    btn.innerText = 'Try Again';
                    alert('Error: ' + e.message);
                }
            };
        };

        // ============================================================================
        // HELPER: Screen Wake Lock (Prevent Sleep during Upload)
        // ============================================================================
        let wakeLock = null;
        let isUploading = false; // Global flag for navigation protection

        // Navigation Guard
        window.addEventListener('beforeunload', (e) => {
            if (isUploading) {
                const msg = 'Upload in progress. Are you sure you want to leave?';
                e.returnValue = msg;
                return msg;
            }
        });

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active: Screen will stay on.');
                } catch (err) {
                    console.error('Wake Lock error:', err);
                }
            }
        }

        async function releaseWakeLock() {
            if (wakeLock !== null) {
                try {
                    await wakeLock.release();
                    wakeLock = null;
                    console.log('Wake Lock released.');
                } catch (err) {
                    console.error('Wake Lock release error:', err);
                }
            }
        }

        async function uploadVideoFile(file) {
            // Request Wake Lock & Set Flag
            await requestWakeLock();
            isUploading = true;

            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('video', file);

                const xhr = new XMLHttpRequest();
                const progressContainer = document.getElementById('modalProgressContainer');
                const progressBar = document.getElementById('modalProgressBar');
                const percentText = document.getElementById('modalUploadPercent');

                progressContainer.style.display = 'block';

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        progressBar.style.width = percent + '%';
                        percentText.innerText = Math.round(percent) + '%';
                    }
                });

                xhr.onreadystatechange = async function () {
                    if (xhr.readyState === 4) {
                        // Release Wake Lock & Reset Flag
                        await releaseWakeLock();
                        isUploading = false;

                        if (xhr.status === 200) {
                            try {
                                const resp = JSON.parse(xhr.responseText);
                                if (resp.success) {
                                    resolve(resp.webViewLink);
                                } else {
                                    reject(new Error(resp.error));
                                }
                            } catch (e) {
                                reject(e);
                            }
                        } else {
                            reject(new Error('Upload failed: ' + xhr.statusText));
                        }
                    }
                };

                xhr.open('POST', '/api/upload-video', true);
                xhr.send(formData);
            });
        }


        // ============================================================================
        // HELPER: In-App Camera Logic
        // ============================================================================
        let mediaStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingInterval = null;
        let isRecording = false;

        window.openCamera = async () => {
            const overlay = document.getElementById('cameraOverlay');
            const videoEl = document.getElementById('cameraPreview');

            try {
                // Force 720p - ideal height 720
                const constraints = {
                    video: {
                        facingMode: 'environment', // Rear camera
                        height: { ideal: 720 }
                    },
                    audio: true
                };

                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoEl.srcObject = mediaStream;
                overlay.style.display = 'flex';
            } catch (err) {
                console.error('Camera Error:', err);
                alert('Could not access camera: ' + err.message);
            }
        };

        window.closeCamera = () => {
            const overlay = document.getElementById('cameraOverlay');
            overlay.style.display = 'none';

            // Stop Stream
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
        };

        // ============================================================================
        // ANALYTICS RENDERER
        // ============================================================================
        async function renderAnalytics(scope = 'today') {
            const container = document.getElementById('mainContent');
            if (!container) return; // Safety check

            // HTML for Buttons
            const buttonsHtml = `
                <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; margin-top: 20px;">
                    <button onclick="renderAnalytics('today')" style="padding: 6px 16px; border-radius: 20px; border: 1px solid #ddd; background: ${scope === 'today' ? '#333' : 'white'}; color: ${scope === 'today' ? 'white' : '#333'}; cursor: pointer;">Today</button>
                    <button onclick="renderAnalytics('week')" style="padding: 6px 16px; border-radius: 20px; border: 1px solid #ddd; background: ${scope === 'week' ? '#333' : 'white'}; color: ${scope === 'week' ? 'white' : '#333'}; cursor: pointer;">Week</button>
                    <button onclick="renderAnalytics('month')" style="padding: 6px 16px; border-radius: 20px; border: 1px solid #ddd; background: ${scope === 'month' ? '#333' : 'white'}; color: ${scope === 'month' ? 'white' : '#333'}; cursor: pointer;">Month</button>
                    <button onclick="renderAnalytics('year')" style="padding: 6px 16px; border-radius: 20px; border: 1px solid #ddd; background: ${scope === 'year' ? '#333' : 'white'}; color: ${scope === 'year' ? 'white' : '#333'}; cursor: pointer;">Year</button>
                </div>
            `;

            container.innerHTML = `
                ${buttonsHtml}
                <div style="display: flex; justify-content: center; padding: 40px;">
                    <div class="loading-spinner"></div>
                </div>
            `;

            try {
                // Fetch Data with Scope
                const response = await fetch(`/api/analytics/summary?scope=${scope}`);
                const stats = await response.json();

                const { pageViews, topVideos, heatmap, totalEvents } = stats;

                // Build Dashboard HTML
                const html = `
                    ${buttonsHtml}
            <div style="padding: 0 20px 80px;">
                <!-- Summary Cards -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div style="flex: 1; background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="font-size: 24px; font-weight: bold; color: #333;">${totalEvents}</div>
                        <div style="font-size: 12px; color: #888; text-transform: uppercase;">Total Events</div>
                    </div>
                    <div style="flex: 1; background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="font-size: 24px; font-weight: bold; color: #333;">${Object.keys(pageViews).length}</div>
                        <div style="font-size: 12px; color: #888; text-transform: uppercase;">Pages Visited</div>
                    </div>
                </div>

                <!-- Top Videos Chart -->
                <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h3 style="margin-top: 0; font-size: 16px; color: #444;">Top Videos</h3>
                    <canvas id="videosChart" style="max-height: 200px;"></canvas>
                </div>

                <!-- Activity Heatmap -->
                <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h3 style="margin-top: 0; font-size: 16px; color: #444;">Activity Heatmap (Hour of Day)</h3>
                    <canvas id="heatmapChart" style="max-height: 150px;"></canvas>
                </div>

                <!-- Recent Activity Feed -->
                <div style="background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h3 style="margin-top: 0; font-size: 16px; color: #444; margin-bottom: 10px;">Recent Activity</h3>
                    <div style="font-size: 12px; color: #666; max-height: 300px; overflow-y: auto;">
                        ${stats.recentActivity.map(e => `
                                    <div style="padding: 8px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                                        <span>
                                            <strong>${e.studentName || 'Guest'}</strong> 
                                            ${e.eventType === 'video_start' ? 'started matching' : e.eventType === 'video_heartbeat' ? 'watched' : 'visited'} 
                                            <em>${e.videoTitle || e.url}</em>
                                        </span>
                                        <span style="color: #999;">${new Date(e.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                    </div>
                                `).join('')}
                    </div>
                </div>
            </div>
            `;

                container.innerHTML = html;

                // Render Charts
                // 1. Heatmap
                new Chart(document.getElementById('heatmapChart'), {
                    type: 'line',
                    data: {
                        labels: Array.from({ length: 24 }, (_, i) => i + ":00"),
                        datasets: [{
                            label: 'Activity',
                            data: heatmap,
                            borderColor: '#3182ce',
                            backgroundColor: 'rgba(49, 130, 206, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });

                // 2. Top Videos (Bar Chart)
                const videoLabels = Object.keys(topVideos).slice(0, 5); // Top 5
                const videoData = videoLabels.map(k => topVideos[k].views);

                new Chart(document.getElementById('videosChart'), {
                    type: 'bar',
                    data: {
                        labels: videoLabels.map(l => l.length > 20 ? l.substring(0, 20) + '...' : l),
                        datasets: [{
                            label: 'Views',
                            data: videoData,
                            backgroundColor: '#FF6B6B',
                            borderRadius: 5
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        scales: { x: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });

            } catch (err) {
                console.error("Analytics Render Error:", err);
                container.innerHTML = `
                    ${buttonsHtml}
            <div class="empty-state">Failed to load analytics.<br><small>${err.message}</small></div>
            `;
            }
        }

        // ============================================================================
        // ASSIGNMENT MODAL LOGIC (Existing)
        // ============================================================================

        // 1. Open Assign Project Modal
        // 1. Open Assign Project Modal
        window.openAssignModal = async (studentId, studentName, headshotUrl) => {
            // Show loading state
            const existingModal = document.getElementById('assignProjectModal');
            if (existingModal) existingModal.remove();

            // Fetch Project List & Student History Concurrently
            let allProjects = [];
            let existingHistory = new Set();
            let studentTrack = ''; // Defined here to resolve scope issue

            try {
                const [listRes, historyRes] = await Promise.all([
                    fetch('/api/all-projects'),
                    fetch(`/api/google-sheets/student-projects/${encodeURIComponent(studentName)}`)
                ]);

                const listData = await listRes.json();
                const historyData = await historyRes.json();

                if (listData.success) {
                    allProjects = listData.projects; // Array of {code, name, category}
                }

                if (historyData.success) {
                    const student = historyData.data || historyData.student; // Handle both just in case

                    if (student) {
                        // Collect all project codes the student has ever touched
                        const addToSet = (arr) => {
                            if (arr) arr.forEach(p => existingHistory.add((p.originalCode || p.code || '').trim().toUpperCase()));
                        };

                        addToSet(student.assignedProjects);
                        addToSet(student.inProgressProjects);
                        addToSet(student.completedProjects);

                        // Capture Track safely inside the scope
                        if (student.track) {
                            studentTrack = student.track.trim().toLowerCase();
                        }
                    }
                }

            } catch (e) {
                console.error(e);
                alert('Error fetching data for assignment');
                return;
            }

            // Filter Projects
            // Filter Projects
            // NOTE: The API returns 'id' for the project code, not 'code'
            // NEW CONDITIONAL: Check if Student's Track (Column AC) is in Project's Recommended Matrix (Column BE)

            // Get student track from historyData (we added it in backend) or fallback
            // historyData.student is the object wrapping lists + metadata
            // But wait, the API structure is: { success: true, student: { track: "...", assignedProjects: [...] } }
            // Let's check where 'track' lives. It should be on 'student' object.

            // NEW CONDITIONAL: Check if Student's Track (Column AC) is in Project's Recommended Matrix (Column BE)

            // studentTrack is already populated above
            console.log(`[AssignModal] Filtering for Student Track: "${studentTrack}"`);

            const availableProjects = allProjects.filter(p => {
                // 1. Check ID exists
                if (!p.id) return false;

                // 2. Check if already done/assigned
                if (existingHistory.has(p.id.trim().toUpperCase())) return false;

                // 3. Check Track Compatibility
                // If student has a track, project MUST include it in recommendedTracks
                const projTracks = (p.recommendedTracks || '').toLowerCase();

                // User Rule: "Show each project if the TRACK of the child... is included as a substring in Column BE"
                // If student has NO track, do we show all? Or none?
                // Assuming show all if no track assigned (fallback), OR show none? 
                // Let's assume strict: if track exists, enforce it.

                if (studentTrack) {
                    if (!projTracks.includes(studentTrack)) {
                        return false; // Track mismatch
                    }
                }

                return true;
            });

            // Group by Category
            const grouped = {};
            availableProjects.forEach(p => {
                const cat = p.category || 'Other';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(p);
            });

            // Generate Options HTML with Optgroups
            // Sort categories logic: Maybe standard ones first?
            const sortedCategories = Object.keys(grouped).sort();

            let optionsHtml = '';

            if (availableProjects.length === 0) {
                optionsHtml = '<div style="padding:20px; text-align:center; color:#888;">No projects available</div>';
            } else {
                sortedCategories.forEach(cat => {
                    optionsHtml += `<div class="custom-select-optgroup">${cat}</div>`;
                    grouped[cat].forEach(p => {
                        optionsHtml += `<div class="custom-select-option" onclick="selectCustomOption('${p.id}', '${p.id} - ${p.name.replace(/'/g, "\\'")}')">${p.id} - ${p.name}</div>`;
                    });
                });
            }

            const modalHtml = `
                <div id="assignProjectModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2500; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; padding: 25px; width: 90%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                        <h3 style="margin-top: 0; margin-bottom: 20px; color: #333; font-size: 20px;">Assign New Project</h3>
                        <div style="display: flex; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <img src="${studentId ? `/headshots/${studentId.toString().replace(/\//g, '_')}.jpg` : (headshotUrl || '/api/placeholder/40/40')}"
                                onerror="this.onerror=null; this.src='${headshotUrl || '/api/placeholder/40/40'}';"
                                style="width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; border: 2px solid #db3236; object-fit: cover;">
                                <div style="font-weight: 600; font-size: 16px;">${studentName}</div>
                        </div>


                        <div style="margin-bottom: 25px;">
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #555; margin-bottom: 8px;">Select Project to Assign</label>
                            
                            <!-- Custom Select Structure -->
                            <div class="custom-select-container" id="customProjectSelectContainer">
                                <div class="custom-select-trigger" onclick="toggleCustomProjectSelect()">
                                    <span id="customSelectLabel">Choose a project...</span>
                                    <i class="fas fa-chevron-down arrow"></i>
                                </div>
                                <div class="custom-select-options">
                                    ${optionsHtml}
                                </div>
                                <input type="hidden" id="assignProjectSelect" value="">
                            </div>

                        </div>

                        <div style="display: flex; gap: 15px;">
                            <button onclick="document.getElementById('assignProjectModal').remove()"
                                style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 15px; color: #666; font-weight: 500;">
                                Cancel
                            </button>
                            <button onclick="submitAssignment('${studentId}', '${studentName}', '${headshotUrl}')"
                                style="flex: 1; padding: 12px; border-radius: 8px; border: none; background: #db3236; color: white; font-weight: bold; cursor: pointer; font-size: 15px; box-shadow: 0 4px 6px rgba(219, 50, 54, 0.2);">
                                Assign Project
                            </button>
                        </div>
                    </div>
            </div >
                `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        };

        // 2. Submit Assignment
        window.submitAssignment = async (studentId, studentName, headshotUrl) => {
            const projectCode = document.getElementById('assignProjectSelect').value;

            if (!projectCode) {
                alert('Please select a project');
                return;
            }

            try {
                // Show loading state
                const btn = document.querySelector('#assignProjectModal button[style*="#db3236"]');
                const origText = btn.innerText;
                btn.innerText = 'Assigning...';
                btn.disabled = true;

                const response = await fetch('/api/assign-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentId: studentId,
                        projectCode: projectCode,
                        instructorName: localStorage.getItem('instructorName') || 'Instructor'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Success
                    document.getElementById('assignProjectModal').remove();

                    // Show Feedback
                    const feedback = document.createElement('div');
                    feedback.style.cssText = 'position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 30px; font-weight: bold; z-index: 3000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px;';
                    feedback.innerHTML = '<span>‚úÖ</span> Project Assigned Successfully!';
                    document.body.appendChild(feedback);
                    setTimeout(() => feedback.remove(), 2500);

                    // Refresh Student Detail View immediately
                    openStudentDetail(studentId, studentName, headshotUrl);

                } else {
                    alert('Error: ' + data.error);
                    btn.innerText = origText;
                    btn.disabled = false;
                }
            } catch (err) {
                console.error(err);
                alert('Failed to connect to server');
            }
        };



        window.toggleRecording = () => {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        };

        function startRecording() {
            recordedChunks = [];
            try {
                // Try to use a small container format if possible, but standard is usually webm or mp4
                const options = { mimeType: 'video/webm;codecs=vp8' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    // Fallback to default
                    mediaRecorder = new MediaRecorder(mediaStream);
                } else {
                    mediaRecorder = new MediaRecorder(mediaStream, options);
                }
            } catch (e) {
                console.warn('MediaRecorder init failed, trying default', e);
                mediaRecorder = new MediaRecorder(mediaStream);
            }

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = uploadRecordedVideo;

            mediaRecorder.start();
            isRecording = true;

            // UI Updates
            const btn = document.getElementById('recordBtn');
            btn.style.background = 'transparent';
            btn.innerHTML = '<div style="width: 30px; height: 30px; background: #ff3b30; border-radius: 4px; margin: 16px;"></div>'; // Stop square

            document.getElementById('recordingTimer').style.display = 'block';
            let seconds = 0;
            document.getElementById('recordingTimer').innerText = "00:00";

            recordingInterval = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('recordingTimer').innerText = `${m}:${s} `;
            }, 1000);
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            resetRecordingUI();
            clearInterval(recordingInterval);
            document.getElementById('recordBtn').innerHTML = '<i class="fas fa-video"></i>';
            document.getElementById('recordBtn').style.background = '#ff3b30';
        }

        // ============================================================================
        // STUDENT DETAIL UI (Matched to Screenshot)
        // ============================================================================

        function renderStudentDetail(studentData, headshotUrl) {
            // We render the container structure here, then populate history
            // The overlay is already shown by openStudentDetail

            // We need to inject the FAB and specific HEADER modifications

            // 1. FAB (Floating Action Button) - MOVED TO INLINE BUTTON
            // We remove the old FAB logic if present to clean up
            let oldFab = document.getElementById('detailFab');
            if (oldFab) oldFab.remove();

            // INJECT "Assign New Project" BUTTON
            // We'll inject it into the project history container, right at the top
            const historyContainer = document.getElementById('projectHistoryList');
            if (historyContainer) {
                // Clear container first (it gets rebuilt anyway, but just to be safe)
                // Wait, renderProjectHistory does this.
                // We need to pass a flag or handle it inside renderProjectHistory?
                // Actually, renderProjectHistory overwrites innerHTML.
                // So we should modify renderProjectHistory instead?
                // Or we can modify how renderProjectHistory wraps things.
                // Let's modify renderProjectHistory below.
            }

            // 2. Custom Header in Overlay
            const detailView = document.getElementById('studentDetailView');
            // Clear previous content to rebuild strict structure
            detailView.innerHTML = `
                <!-- CUSTOM BLUE HEADER -->
                <div style="background: #2D3748; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; color: white; position: relative;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button onclick="closeStudentDetail()" style="background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; padding: 5px;">
                             <!-- Back Arrow Icon -->
                             <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="19" y1="12" x2="5" y2="12"></line>
                                <polyline points="12 19 5 12 12 5"></polyline>
                            </svg>
                        </button>
                        <img src="/api/placeholder/32/32" style="width:32px; opacity:0.8;"> <!-- Robot Icon Placeholder -->
                        <div style="font-weight: 500; font-size: 18px; text-transform: uppercase;">${studentData.studentName}</div>
                    </div>
                    <div style="display: flex; gap: 15px;">
                        <span onclick="openStudentDetail('${studentData.studentId}', '${studentData.studentName}', '${headshotUrl}')" style="cursor:pointer;">üîÑ</span>
                    </div>
                    
                    <!-- Loading Bar -->
                    <div id="detailLoadingBar" style="position: absolute; bottom: 0; left: 0; width: 0%; height: 3px; background: #4fd1c5; transition: width 0.3s; display: none;"></div>
                </div>

               <!-- PROFILE BANNER -->
               <div style="background: white; padding: 30px 20px 20px; text-align: center; border-bottom: 4px solid #db3236;">
                   <div style="position: relative; display: inline-block;">
                       <img src="${studentData.studentId ? `/headshots/${studentData.studentId.toString().replace(/\//g, '_')}.jpg` : headshotUrl}"
                            onerror="this.onerror=null; this.src='${headshotUrl || '/api/placeholder/120/120'}';" 
                            style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #db3236; padding: 3px;">
                   </div>
                   <div style="font-size: 22px; font-weight: 700; color: #333; margin-top: 10px; margin-bottom: 5px;">
                       ${studentData.studentName}
                   </div>
                   
                   <div style="display: flex; justify-content: center; gap: 40px; margin-top: 10px;">
                       <div style="text-align: center;">
                           <div id="detailPoints" style="font-size: 20px; font-weight: 700; color: #db3236;">${studentData.totalPoints || 0}</div>
                           <div style="font-size: 11px; color: #888; text-transform: uppercase;">POINTS</div>
                       </div>
                       <div style="text-align: center;">
                           <div id="detailCompleted" style="font-size: 20px; font-weight: 700; color: #333;">${studentData.totalCompleted || 0}</div>
                           <div style="font-size: 11px; color: #888; text-transform: uppercase;">COMPLETED</div>
                       </div>
                   </div>
               </div>

                <!-- SCROLLABLE LIST AREA -->
                <div id="projectHistoryList" style="padding-bottom: 100px;">
                    <div class="loading-spinner" style="margin: 20px auto;"></div>
                </div>
            `;
        }
        window.openStudentDetail = async (studentId, studentName, headshotUrl) => {
            const detailView = document.getElementById('studentDetailView');
            const mainContent = document.getElementById('mainContent');

            // Show Loading State or immediate switch
            // We rely on renderStudentDetail to build the UI, so we just show the view container
            mainContent.style.display = 'none';
            detailView.style.display = 'block';

            // Initial render with basic info while loading?
            // Optional, but let's just show loading spinner in the list area if it exists
            // Or better, let's call renderStudentDetail immediately with partial data!
            renderStudentDetail({ studentId, studentName, totalPoints: '...', totalCompleted: '...' }, headshotUrl);

            if (window.showDetailLoading) window.showDetailLoading();

            window.scrollTo(0, 0);

            // Fetch History
            const container = document.getElementById('projectHistoryList');
            if (container) container.innerHTML = '<div class="loading-spinner" style="margin: 20px auto;"></div>';



            try {
                // ... rest of fetch logic is fine ...
                console.log('Fetching student history...');

                const response = await fetch(`/api/student-projects/${encodeURIComponent(studentId)}`);
                const data = await response.json();


                if (data.success && data.student) {
                    renderProjectHistory(data.student, studentId, studentName, headshotUrl);
                    // Update Stats
                    document.getElementById('detailPoints').innerText = data.student.totalPoints || 0;
                    document.getElementById('detailCompleted').innerText = data.student.totalCompleted || 0;
                } else {
                    console.log('Project history data.success is false or data.student missing', data);
                    container.innerHTML = '<p style="text-align:center; padding: 20px;">No projects found (Server data empty).</p>';
                }
                if (window.hideDetailLoading) window.hideDetailLoading();
            } catch (e) {
                if (window.hideDetailLoading) window.hideDetailLoading();
                console.error(e);
                container.innerHTML = '<p style="text-align:center; padding: 20px; color: red;">Error loading history.</p>';
            }
        };

        function renderProjectHistory(projects, studentId, studentName, headshotUrl) {

            const container = document.getElementById('projectHistoryList');
            if (!container) {

                return;
            }


            try {
                projects = projects || {};


                let html = '';

                if (typeof renderSectionWithAction === 'function') {
                    html += renderSectionWithAction('Assigned Projects', projects.assignedProjects, 'üìå', '#db3236', studentId, studentName, headshotUrl);
                    html += renderSectionWithAction('Working On', projects.inProgressProjects, 'üöß', '#3182ce', studentId, studentName, headshotUrl);
                    html += renderSectionWithAction('Completed', projects.completedProjects, '‚úÖ', '#38a169', studentId, studentName, headshotUrl);
                } else {
                    html = '<div style="padding:20px; text-align:center; color:red;">Error: Renderer missing</div>';
                }

                // PREPEND THE "ASSIGN PROJECT" BUTTON
                const safeHeadshot = headshotUrl || '/api/placeholder/40/40';
                const assignBtnHtml = `
                <div style="padding: 15px 15px 5px;">
                    <button onclick="openAssignModal('${studentId}', '${studentName.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${safeHeadshot}')" 
                        style="width: 100%; background: #db3236; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 700; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; box-shadow: 0 4px 6px rgba(219, 50, 54, 0.2);">
                        <i class="fas fa-plus-circle"></i> Assign New Project
                    </button>
                </div>
            `;



                const finalHtml = assignBtnHtml + html;
                container.innerHTML = finalHtml;

            } catch (err) {

                console.error('Error in renderProjectHistory:', err);
                container.innerHTML = `<div style="padding: 20px; color: red;">Error: ${err.message}</div>`;
            }
        }

        function resetRecordingUI() {
            document.getElementById('recordingTimer').style.display = 'none';
            document.getElementById('recordBtn').innerHTML = '';
            document.getElementById('recordBtn').style.background = '#ff3b30';
            isRecording = false;
            clearInterval(recordingInterval);
        }

        async function uploadRecordedVideo() {
            // Compile Blob
            const blob = new Blob(recordedChunks, { type: 'video/webm' });

            // Close the Camera Overlay immediately
            window.closeCamera();

            // Generate a Filename
            const date = new Date().toISOString().slice(0, 10);
            const filename = `recording_${date}.webm`;

            // Update UPLOAD UI in Modal to show we are working
            document.getElementById('modalFileName').innerText = "üé• " + filename;

            // Disable Main Button to prevent double submit
            const btn = document.getElementById('completeBtn');
            btn.disabled = true;
            btn.innerText = "Auto-Uploading...";
            btn.style.background = '#db3236';

            // TRIGGER AUTO UPLOAD
            try {
                const videoLink = await uploadVideoFile(blob); // uploadVideoFile handles blobs

                // Store the Link and enable completion
                let secretInput = document.getElementById('hiddenUploadedLink');
                if (!secretInput) {
                    secretInput = document.createElement('input');
                    secretInput.type = 'hidden';
                    secretInput.id = 'hiddenUploadedLink';
                    document.getElementById('editMode').appendChild(secretInput); // Append to editMode container
                }
                secretInput.value = videoLink;

                btn.innerText = "Video Uploaded! Click to Finish.";
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.style.background = '#047857'; // Green to indicate success

            } catch (err) {
                console.error('Auto Upload Failed:', err);
                alert('Auto-Upload Failed: ' + err.message);
                btn.innerText = "Upload Failed";
            }
        }
        // ============================================================================
        // INVENTORY RENDERER
        // ============================================================================

        let inventoryItems = [];
        let inventoryKits = [];
        let currentKit = '';

        async function renderInventory(container) {
            container.innerHTML = '<div class="loading-container">Loading Inventory...</div>';

            try {
                const response = await fetch('/api/inventory');
                const data = await response.json();

                if (!data.success) throw new Error(data.error);

                inventoryItems = data.items;
                inventoryKits = data.kits;

                // Set default kit if not set
                if (!currentKit && inventoryKits.length > 0) {
                    currentKit = inventoryKits[0];
                }

                renderInventoryUI(container);

            } catch (e) {
                container.innerHTML = `<div class="empty-state"><h3>Error loading inventory</h3><p>${e.message}</p></div>`;
            }
        }

        let inventorySearchTerm = '';
        let inventoryFilterStatus = 'all'; // 'all', 'low', 'medium', 'full'

        function renderInventoryUI(container) {
            if (inventoryKits.length === 0) {
                container.innerHTML = '<div class="empty-state">No inventory kits detected. Check Google Sheet headers.</div>';
                return;
            }

            // 1. Kit Selector HTML
            let kitButtons = inventoryKits.map(kit => {
                const isActive = kit === currentKit;
                return `
                <button onclick="switchKit('${kit}')"
            style="padding: 8px 16px; border-radius: 20px; border: 1px solid ${isActive ? '#db3236' : '#ccc'}; background: ${isActive ? '#db3236' : 'white'}; color: ${isActive ? 'white' : '#666'}; font-weight: 500; margin-right: 8px; cursor: pointer;">
                ${kit}
                </button>`;
            }).join('');

            // 2. Search Bar HTML
            const searchBarHtml = `
                <div style="padding: 10px 15px; background: white; border-bottom: 1px solid #eee;">
                    <input type="text"
                        id="inventorySearchInput"
                        placeholder="Search ${currentKit} Items..."
                        value="${inventorySearchTerm}"
                        oninput="handleInventorySearch(this.value)"
                        style="width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none;">
                    </div>
            `;

            // 3. Status Filter HTML ("What are you low on?")
            const filterButtonsHtml = `
                <div style="padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; display: flex; gap: 8px; overflow-x: auto;">
                <button onclick="setInventoryFilter('all')" 
                    style="flex: 1; padding: 6px; border-radius: 6px; border: 1px solid ${inventoryFilterStatus === 'all' ? '#333' : '#ddd'}; background: ${inventoryFilterStatus === 'all' ? '#333' : 'white'}; color: ${inventoryFilterStatus === 'all' ? 'white' : '#666'}; font-size: 13px;">
                    Show All
                </button>
                <button onclick="setInventoryFilter('Low')" 
                    style="flex: 1; padding: 6px; border-radius: 6px; border: 1px solid ${inventoryFilterStatus === 'Low' ? '#db3236' : '#ddd'}; background: ${inventoryFilterStatus === 'Low' ? '#db3236' : 'white'}; color: ${inventoryFilterStatus === 'Low' ? 'white' : '#666'}; font-size: 13px;">
                    ‚ö†Ô∏è Low Only
                </button>
                <button onclick="setInventoryFilter('Medium')" 
                    style="flex: 1; padding: 6px; border-radius: 6px; border: 1px solid ${inventoryFilterStatus === 'Medium' ? '#f4b400' : '#ddd'}; background: ${inventoryFilterStatus === 'Medium' ? '#f4b400' : 'white'}; color: ${inventoryFilterStatus === 'Medium' ? 'white' : '#666'}; font-size: 13px;">
                    Medium
                </button>
                <button onclick="setInventoryFilter('Full')" 
                    style="flex: 1; padding: 6px; border-radius: 6px; border: 1px solid ${inventoryFilterStatus === 'Full' ? '#0f9d58' : '#ddd'}; background: ${inventoryFilterStatus === 'Full' ? '#0f9d58' : 'white'}; color: ${inventoryFilterStatus === 'Full' ? 'white' : '#666'}; font-size: 13px;">
                    Full
                </button>
            </div>
                `;

            // Combine Header
            const headerHtml = `
                <div style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; overflow-x: auto; white-space: nowrap; position: sticky; top: 0; z-index: 10;">
                    ${kitButtons}
            </div>
                ${searchBarHtml}
            ${filterButtonsHtml}
            `;

            const wrapperId = 'inventory-view-wrapper';
            if (!document.getElementById(wrapperId)) {
                container.innerHTML = `
                <div id="${wrapperId}">
                        <div id="inventory-header-container">${headerHtml}</div>
                        <div id="inventory-list-container" style="background: white; padding-bottom: 80px;"></div>
                    </div>
                `;
            } else {
                document.getElementById('inventory-header-container').innerHTML = headerHtml;
            }

            renderInventoryItems();

            window.switchKit = (kit) => {
                currentKit = kit;
                renderInventoryUI(container);
            };

            window.handleInventorySearch = (val) => {
                inventorySearchTerm = val;
                renderInventoryItems();
            };

            window.setInventoryFilter = (status) => {
                inventoryFilterStatus = status;
                // Re-render header to update active state of buttons
                renderInventoryUI(container);
            };
        }

        function renderInventoryItems() {
            const listContainer = document.getElementById('inventory-list-container');
            if (!listContainer) return;

            // Filter Items
            const term = inventorySearchTerm.toLowerCase();
            const filtered = inventoryItems.filter(item => {
                const name = (item.product || '').toLowerCase();
                const id = (item.id || '').toString().toLowerCase();
                const matchesTerm = name.includes(term) || id.includes(term);

                if (!matchesTerm) return false;

                // Status Filter
                if (inventoryFilterStatus === 'all') return true;

                const status = (item.stocks[currentKit] || '').toLowerCase();
                return status === inventoryFilterStatus.toLowerCase();
            });

            if (filtered.length === 0) {
                listContainer.innerHTML = '<div class="empty-state">No matching items found.</div>';
                return;
            }

            const itemsHtml = filtered.map(item => {
                const status = item.stocks[currentKit] || ''; // 'Low', 'Medium', 'Full' or empty
                const safeId = item.id;
                const safeName = item.product || 'Unknown Item';
                const lastUpdated = (item.lastUpdated && item.lastUpdated[currentKit]) ? item.lastUpdated[currentKit] : '';

                // Helper to check active status
                const isLow = status.toLowerCase() === 'low';
                const isMed = status.toLowerCase() === 'medium';
                const isFull = status.toLowerCase() === 'full';

                return `
                < div class="student-card" style = "padding: 10px 20px;" >
                    < !--Image -->
                    <div style="width: 50px; height: 50px; margin-right: 16px; flex-shrink: 0; background: #eee; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                        <img src="${item.image || ''}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.innerText='üì¶';">
                         <div style="font-size: 20px;"></div>
                    </div>

                    <!--Info -->
                    <div class="student-info">
                        <div class="student-name" style="font-size: 15px;">${safeName}</div>
                        <div class="student-project" style="font-size: 12px; color: #888;">ID: ${safeId}</div>
                        ${lastUpdated ? `<div style="font-size: 11px; color: #059669; font-style: italic; margin-top: 2px;">Updated: ${lastUpdated}</div>` : ''}
                    </div>

                    <!--Status Actions-- >
                <div style="display: flex; gap: 4px;">
                    <button onclick="updateInventoryStatus('${safeId}', 'Low')"
                        style="padding: 6px 12px; border-radius: 6px; border: 1px solid ${isLow ? '#db3236' : '#ddd'}; background: ${isLow ? '#db3236' : '#f8f9fa'}; color: ${isLow ? 'white' : '#666'}; font-size: 13px; cursor: pointer; font-weight: 500;">
                        Low
                    </button>
                    <button onclick="updateInventoryStatus('${safeId}', 'Medium')"
                        style="padding: 6px 12px; border-radius: 6px; border: 1px solid ${isMed ? '#f4b400' : '#ddd'}; background: ${isMed ? '#f4b400' : '#f8f9fa'}; color: ${isMed ? 'white' : '#666'}; font-size: 13px; cursor: pointer; font-weight: 500;">
                        Med
                    </button>
                    <button onclick="updateInventoryStatus('${safeId}', 'Full')"
                        style="padding: 6px 12px; border-radius: 6px; border: 1px solid ${isFull ? '#0f9d58' : '#ddd'}; background: ${isFull ? '#0f9d58' : '#f8f9fa'}; color: ${isFull ? 'white' : '#666'}; font-size: 13px; cursor: pointer; font-weight: 500;">
                        Full
                    </button>
                </div>
                </div >
                `;
            }).join('');

            listContainer.innerHTML = itemsHtml;
        }

        async function updateInventoryStatus(itemId, newStatus) {
            // Find item
            const item = inventoryItems.find(i => i.id === itemId);
            if (!item) return;

            // Check if redundant update? Optional.
            // if (item.stocks[currentKit] === newStatus) return;

            // Optimistic Update
            item.stocks[currentKit] = newStatus;

            // Optimistic Timestamp Update
            item.lastUpdated = item.lastUpdated || {};
            item.lastUpdated[currentKit] = new Date().toLocaleString();

            // Re-render UI (keeping scroll / focus logic if possible? Full re-render is simplest for now)
            renderInventoryItems(); // Just re-render list, keeps Header intact.

            try {
                const response = await fetch('/api/inventory/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        itemId: itemId,
                        kitName: currentKit,
                        newStatus: newStatus,
                        userEmail: 'Instructor'
                    })
                });
                const data = await response.json();
                if (!data.success) {
                    console.error('Update failed:', data.error);
                    // Could revert here if needed
                }
            } catch (err) {
                console.error('Update error:', err);
            }
        }

        // ============================================================================
        // UTILITIES
        // ============================================================================

        window.closeStudentDetail = function () {
            const view = document.getElementById('studentDetailView');
            const mainContent = document.getElementById('mainContent');
            if (view) view.style.display = 'none';
            if (mainContent) mainContent.style.display = 'block';
        };

        window.showDetailLoading = function () {
            const bar = document.getElementById('detailLoadingBar');
            if (bar) {
                bar.style.display = 'block';
                setTimeout(() => bar.style.width = '70%', 10);
            }
        };

        window.hideDetailLoading = function () {
            const bar = document.getElementById('detailLoadingBar');
            if (bar) {
                bar.style.width = '100%';
                setTimeout(() => {
                    bar.style.display = 'none';
                    bar.style.width = '0%';
                }, 300);
            }
        };
    </script>
    <script>
        // Custom Dropdown Logic
        window.toggleCustomProjectSelect = function () {
            const container = document.getElementById('customProjectSelectContainer');
            if (container) container.classList.toggle('open');
        };

        window.selectCustomOption = function (value, label) {
            // Update Hidden Input (Logic uses this)
            document.getElementById('assignProjectSelect').value = value;

            // Update Display Label
            document.getElementById('customSelectLabel').innerText = label;
            document.getElementById('customSelectLabel').style.color = '#333';
            document.getElementById('customSelectLabel').style.fontWeight = '600';

            // Close Dropdown
            document.getElementById('customProjectSelectContainer').classList.remove('open');

            // Prevent event bubbling
            if (event) event.stopPropagation();
        };

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            const container = document.getElementById('customProjectSelectContainer');
            // Check if click is outside container
            if (container && !container.contains(e.target)) {
                container.classList.remove('open');
            }
        });

        function handleInstructorLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('instructorLoggedIn');
                localStorage.removeItem('instructorName');
                window.location.href = '/';
            }
        }

        // Check Login Status on Load
        document.addEventListener('DOMContentLoaded', () => {
            const isLoggedIn = localStorage.getItem('instructorLoggedIn') === 'true';

            if (!isLoggedIn) {
                // Show Login Modal
                const modal = document.getElementById('instructorLoginModal');
                if (modal) {
                    modal.style.display = 'flex'; // Ensure flex layout for centering
                    modal.classList.add('active'); // Add active class if used by CSS
                } else {
                    alert('Error: Login modal missing. Please refresh.');
                }
            }

            // ... rest of initialization ...
            // ... rest of initialization ...
        });

        // Fetch and display Data Source ID
        /*
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/api/config/spreadsheet-id')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.spreadsheetId) {
                        const badge = document.createElement('div');
                        badge.style.position = 'fixed';
                        badge.style.bottom = '85px'; // Above tabs
                        badge.style.right = '10px';
                        badge.style.background = 'rgba(0,0,0,0.6)';
                        badge.style.color = '#fff';
                        badge.style.padding = '4px 8px';
                        badge.style.borderRadius = '4px';
                        badge.style.fontSize = '10px';
                        badge.style.zIndex = '9999';
                        badge.style.pointerEvents = 'none'; // Don't block clicks
                        badge.innerText = 'Data Source: ' + data.spreadsheetId;
                        document.body.appendChild(badge);
                    }
                })
                .catch(err => console.error('Failed to get Spreadsheet ID', err));
        });
        */
    </script>

</body>

</html>