<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnToBot Class - Projects</title>
    <link rel="stylesheet" href="kids-theme.css">
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="mobile.css">
    <link rel="stylesheet" href="navbar.css">
    <script src="analytics.js" defer></script> <!-- Analytics Telemetry -->
    <script src="inactivity.js" defer></script> <!-- Shared Logout Logic -->
</head>

<body>
    <!-- 1. Initial Loading Screen (Visible by default) -->
    <div id="initialLoader">
        <div style="font-size: 4em; animation: bounce 1s infinite;">ü§ñ</div>
        <div style="margin-top: 20px; color: #9CA3AF;">Loading Class...</div>
    </div>
    <script>
        // EMERGENCY LOADER KILLER
        // If app.js fails or hangs, this ensures the user isn't stuck forever.
        setTimeout(() => {
            const l = document.getElementById('initialLoader');
            if (l && l.style.display !== 'none') {
                console.error('Check: Emergency Loader Removal Triggered');
                l.style.opacity = '0';
                setTimeout(() => l.style.display = 'none', 500);
            }
        }, 8000); 
    </script>

    <!-- 2. Login Gate (Hidden by default, shown if Auth fails) -->
    <div id="loginGate" style="display: none;">
        <div
            style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at center, #1F2937 0%, #111827 100%); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;">
            <div style="font-size: 5em; margin-bottom: 20px; animation: bounce 2s infinite;">ü§ñ</div>
            <h1
                style="font-size: 3em; font-weight: 800; margin-bottom: 10px; text-shadow: 0 4px 10px rgba(0,0,0,0.5); color: white !important;">
                Welcome to LearnToBot</h1>
            <p style="color: #9CA3AF; font-size: 1.2em; margin-bottom: 40px;">Please login to access your projects and
                classes.</p>
            <!-- FIXED: Calls toggleLoginModal() and proper Z-Index -->
            <button onclick="toggleLoginModal()" class="action-btn"
                style="padding: 15px 40px; font-size: 1.3em; box-shadow: 0 10px 30px rgba(59, 130, 246, 0.5);">
                üöÄ Student Login
            </button>
            <div style="margin-top: 20px; font-size: 0.9em; opacity: 0.6;">Protected Class Area</div>
        </div>
    </div>

    <nav class="navbar protected-content">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">
                <img src="assets/logo.png" alt="LearnToBot" class="navbar-logo-img">
                <span class="brand-text">LEARNTOBOT</span>
            </a>

            <!-- Hamburger Button -->
            <!-- Mobile menu button handled by mobile-nav.js -->

            <ul class="navbar-menu">
                <li><a href="/" class="navbar-link active">Projects</a></li>
                <li><a href="/child-progress.html" class="navbar-link">Student Progress</a></li>
                <li><a href="/prizes.html" class="navbar-link">Prizes</a></li>
                <li><a href="/leaderboard.html" class="navbar-link">Leaders</a></li>
                <li><a href="/teacher.html" class="navbar-link">Teacher</a></li>

            </ul>

            <div class="navbar-auth">
                <div id="userProfilePill" class="user-profile-pill" style="display: none;">
                    <div class="user-points">
                        <span class="points-icon">üíé</span>
                        <span id="userPointsDisplay">0</span>
                    </div>
                    <div class="user-info">
                        <span id="userNameDisplay">Student</span>
                        <img id="userHeadshotDisplay" src="" alt="Profile" class="user-headshot-nav"
                            onerror="this.style.display='none'">
                    </div>
                </div>

                <span class="navbar-user" id="navbarUser" style="display: none;"></span>
                <!-- Legacy, keeping hidden just in case -->

                <button class="navbar-btn" id="navbarLoginBtn" onclick="toggleLoginModal()">Login</button>
                <button class="navbar-btn logout" id="navbarLogoutBtn" onclick="logout()"
                    style="display: none;">Logout</button>
            </div>
        </div>
    </nav>

    </nav>

    <div id="student-folder-sidebar">
        <h3 id="sidebar-title">Student Folders</h3>

        <!-- Search input for Logged Out state -->
        <div id="sidebar-search-container" style="display: none;">
            <input type="text" id="sidebar-folder-search" placeholder="üîç Search student..."
                class="sidebar-search-input">
        </div>

        <!-- Action buttons for Logged In state -->
        <div id="sidebar-actions" style="display: none;">
            <button id="open-my-folder-btn" class="sidebar-action-btn" onclick="openCurrentStudentFolder()">
                üìÇ Open My Folder
            </button>



            <!-- New: Copy Path Feature -->
            <div id="folder-path-container"
                style="display: none; margin-top: 10px; background: #374151; padding: 10px; border-radius: 8px;">
                <div style="font-size: 0.8em; color: #9CA3AF; margin-bottom: 5px;">Folder Path:</div>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="folder-path-input" readonly
                        style="width: 100%; background: #1F2937; border: 1px solid #4B5563; color: white; padding: 5px; border-radius: 4px; font-size: 0.8em;">
                    <button onclick="copyFolderPath()" title="Copy Path"
                        style="background: #3B82F6; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                        üìã
                    </button>
                </div>
            </div>
        </div>

        <div id="folder-list-container">
            <ul id="sidebar-list" style="list-style: none; padding: 0;">
                <!-- Items will be dynamically inserted here -->
            </ul>
        </div>
    </div>

    <div id="loginModal" class="modal-overlay" onclick="if(event.target === this) toggleLoginModal()">
        <div class="modal">
            <div class="modal-header">
                <h2>üëã Welcome!</h2>
                <button class="close-modal" onclick="toggleLoginModal()">√ó</button>
            </div>

            <!-- VIEW 1: CLASS VIEW (Default for Offline) -->
            <div id="classLoginView">
                <!-- SEARCH BAR (Always Visible) -->
                <input type="text" id="studentSearch" class="search-box" placeholder="üîç Search for your name..."
                    autocomplete="off" style="margin-bottom: 15px;">

                <!-- SECTION A: TODAY'S CLASSES (Default) -->


                <!-- SECTION B: SEARCH RESULTS (Hidden by default) -->
                <div id="studentList" class="student-list" style="display: none; max-height: 55vh; overflow-y: auto;">
                </div>
            </div>

            <!-- REMOVED: Separate Search View -->

            <!-- VIEW 3: ONLINE PARENT LOGIN (New) -->
            <div id="onlineParentView" style="display: none;">

                <!-- Step 1: Email Input -->
                <div id="parentEmailStep">
                    <p style="color: #9CA3AF; text-align: center; margin-bottom: 20px;">
                        Enter the parent email address registered with us to find your student account.
                    </p>

                    <div style="margin-bottom: 20px;">
                        <input type="email" id="parentEmailInput" placeholder="Enter Parent Email"
                            onkeypress="if(event.key === 'Enter') checkParentEmail()"
                            style="width: 100%; padding: 15px; background: #111827; border: 2px solid #374151; border-radius: 10px; color: white; font-size: 1.1em; box-sizing: border-box;">
                    </div>

                    <div id="parentEmailError"
                        style="color: #EF4444; margin-bottom: 15px; text-align: center; display: none;"></div>

                    <button id="findKidsBtn" onclick="checkParentEmail()"
                        style="width: 100%; background: #3B82F6; color: white; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1em; transition: background 0.2s;">
                        Find My Kids
                    </button>
                </div>

                <!-- Step 2: Select Child -->
                <div id="parentChildSelectStep" style="display: none;">
                    <h3 style="color: white !important; margin-bottom: 15px; text-align: center;">Select Student
                    </h3>
                    <div id="foundChildrenList"
                        style="display: flex; flex-direction: column; gap: 10px; max-height: 50vh; overflow-y: auto;">
                        <!-- Children buttons will go here -->
                    </div>

                    <button onclick="resetParentLogin()"
                        style="margin-top: 20px; width: 100%; background: transparent; border: none; color: #9CA3AF; text-decoration: underline; cursor: pointer;">
                        &lt; Search with different email
                    </button>
                </div>


            </div>

            <div class="login-footer" id="loginModalFooter"
                style="margin-top: 20px; border-top: 1px solid #374151; padding-top: 15px; text-align: center;">
                <button id="skipLoginBtn" onclick="skipLogin()"
                    style="background: none; border: none; color: #9CA3AF; text-decoration: underline; cursor: pointer; font-size: 0.9em;">
                    Continue without logging in
                </button>
                <!-- INSTRUCTOR LOGIN LINK (REMOVED FROM HOMEPAGE) -->
                <div id="instructorLoginContainer" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Instructor Login Modal -->
    <div id="instructorLoginModal" class="modal-overlay" onclick="if(event.target === this) closeInstructorLogin()">
        <div class="modal"
            style="max-width: 400px; background: #1F2937; padding: 30px; border-radius: 20px; border: 2px solid #374151;">
            <div class="modal-header"
                style="border-bottom: 1px solid #374151; padding-bottom: 15px; margin-bottom: 20px;">
                <h2 style="color: #60A5FA; font-size: 1.5em;">üë®‚Äçüè´ Instructor Login</h2>
                <button class="close-modal" onclick="closeInstructorLogin()">√ó</button>
            </div>

            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div>
                    <label
                        style="color: #9CA3AF; font-size: 0.9em; margin-bottom: 8px; display: block; font-weight: 600;">Instructor
                        Name</label>
                    <select id="instructorSelect"
                        style="width: 100%; padding: 12px; background: #111827; border: 2px solid #374151; color: white; border-radius: 10px; font-size: 1em;">
                        <option value="">Select your name...</option>
                    </select>
                </div>

                <div>
                    <label
                        style="color: #9CA3AF; font-size: 0.9em; margin-bottom: 8px; display: block; font-weight: 600;">Passcode</label>
                    <input type="password" id="instructorPasscode"
                        style="width: 100%; padding: 12px; background: #111827; border: 2px solid #374151; color: white; border-radius: 10px; font-size: 1em;"
                        placeholder="Enter 4-digit code">
                </div>

                <div id="instructorLoginError"
                    style="background: rgba(239, 68, 68, 0.1); color: #EF4444; padding: 10px; border-radius: 8px; font-size: 0.9em; display: none; border: 1px solid rgba(239, 68, 68, 0.2);">
                </div>

                <button onclick="submitInstructorLogin()"
                    style="background: #3B82F6; color: white; padding: 14px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1em; transition: all 0.2s;">
                    Login to Dashboard
                </button>

                <button onclick="closeInstructorLogin()"
                    style="background: transparent; color: #9CA3AF; padding: 10px; border: none; cursor: pointer; font-size: 0.9em; text-decoration: underline;">
                    Cancel and go back
                </button>
            </div>
        </div>
    </div>

    <div class="page-content">


        <div class="header protected-content">
            <h1>ü§ñ LearnToBot Class</h1>
            <p>Choose a project to get started</p>
        </div>

        <!-- Marquee Section -->
        <div id="leaderboardMarquee" class="marquee-container protected-content" style="display: none;">
            <div class="marquee-content" id="marqueeContent">
                <!-- Content injected by JS -->
            </div>
        </div>

        <div class="leaderboard-link-wrapper protected-content">
            <a href="/leaderboard.html" class="view-leaderboard-btn">üèÜ View Full Leaderboard</a>
        </div>

        <div class="search-container protected-content">
            <input type="text" class="search-box" id="searchBox" placeholder="üîç Search projects..." />
            <div class="search-dropdown" id="searchDropdown"></div>
        </div>

        <div id="searchNotice" class="search-active-notice" style="display: none;">
            Showing search results
        </div>

        <div id="assignedProjectsContainer"></div>

        <!-- [NEW] Filter Controls (Only visible when logged in) -->
        <div id="filterControls" style="display: none; justify-content: flex-end; padding: 0 40px; margin-bottom: 5px;">
            <label
                style="color: #E5E7EB; font-weight: 600; display: flex; align-items: center; gap: 8px; cursor: pointer; background: #374151; padding: 6px 15px; border-radius: 20px; font-size: 0.9em; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                <input type="checkbox" id="hideCompletedFilter" checked onchange="refreshCurrentView()">
                Hide Completed Projects
            </label>
        </div>

        <div id="tabsContainer" class="tabs-container protected-content"></div>
        <div id="subTabsContainer" class="tabs-container protected-content" style="display: none;"></div>

        <div id="content" class="protected-content">
            <div class="loading">Loading projects...</div>
        </div>


        <script src="/socket.io/socket.io.js"></script>

        <a href="/connections.html" target="_blank" class="connection-monitor-btn" id="connectionBtn">
            <span>üåê Connections</span>
            <span class="connection-count">0</span>
        </a>

    </div> <!-- Close page-content -->
    <footer>
        <p>Last Updated: <span id="last-updated"></span></p>
    </footer>
    <script src="mode-indicator.js"></script>
    <!-- mobile-nav.js is loaded at the end with versioning -->
    <!-- Marquee Logic -->
    <script src="mobile-nav.js?v=2"></script>

    <script src="tutorial.js"></script>
    <!-- How To Use Modal -->
    <div id="howToUseModal" class="modal-overlay" onclick="if(event.target === this) toggleHowToUseModal()">
        <div class="modal"
            style="max-width: 600px; padding: 20px; background: #1F2937; border-radius: 12px; border: 1px solid #374151; text-align: center; margin: 20px;">
            <div class="modal-header"
                style="justify-content: space-between; align-items: center; display: flex; margin-bottom: 15px;">
                <h2 style="margin: 0; font-size: 1.5rem; color: #F3F4F6;">üöÄ Portal Tour</h2>
                <button class="close-modal" onclick="toggleHowToUseModal()"
                    style="background: none; border: none; font-size: 2rem; color: #9CA3AF; cursor: pointer;">√ó</button>
            </div>

            <div
                style="margin-bottom: 20px; background: #000; border-radius: 8px; overflow: hidden; display: flex; justify-content: center;">
                <!-- PERFORMANCE: Lazy loaded GIF -->
                <img id="howToUseGif" data-src="/howtouse.gif" src="" alt="How to use the portal"
                    style="width: auto; max-width: 100%; height: auto; max-height: 50vh; display: block;">
            </div>

            <p style="color: #D1D5DB; margin-bottom: 20px; font-size: 1rem; line-height: 1.5;">
                Welcome to the LearnToBot parent portal! Here is a quick tour of how to view your child's progress,
                assigned
                projects, and download files.
            </p>

            <button onclick="toggleHowToUseModal()"
                style="background: #3B82F6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                Got it!
            </button>
        </div>
    </div>


    <script>
        // [NEW] Fetch and display Site Version
        document.addEventListener('DOMContentLoaded', function () {
            fetch('/api/config')
                .then(r => r.json())
                .then(data => {
                    const versionEl = document.getElementById('site-version-text');
                    if (versionEl && data.siteVersion) {
                        versionEl.textContent = 'v' + data.siteVersion;
                    }
                })
                .catch(e => console.error('Version fetch failed', e));
        });
    </script>
    <div id="site-version"
        style="position: fixed; bottom: 5px; right: 5px; color: rgba(255,255,255,0.2); font-size: 0.8rem; pointer-events: none; user-select: none; font-family: monospace; z-index: 9999;">
        <span id="site-version-text">v...</span>
    </div>
    <script src="app.js?v=2" defer></script>
</body>

</html>